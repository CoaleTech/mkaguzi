var f=(E,c,_)=>new Promise((C,t)=>{var x=v=>{try{p(_.next(v))}catch(V){t(V)}},h=v=>{try{p(_.throw(v))}catch(V){t(V)}},p=v=>v.done?C(v.value):Promise.resolve(v.value).then(x,h);p((_=_.apply(E,c)).next())});import{g as k,a as m,c as S,A as re,b as de}from"./index-qIC3Tfxg.js";import{ap as ue,ab as ce,r as j,Q as ve,j as q,l as d,p as l,q as e,H as g,s as o,u,v as n,A as i,z as y,B as w,y as b,F as O,x as B}from"./vue-DciwFjI_.js";import{aL as me,aa as ge,an as _e,Y as pe,F as D,b9 as ye,U as fe,bt as xe,a9 as be,a0 as he,bu as we,O as ke,Q as Ce,m as L,n as U,T as Ve,f as Ie,d as je,N as qe}from"./icons-CtLkBOsu.js";import"./charts-DlPBe6v3.js";import"./utils-Bcd7wHeW.js";const Ae={class:"p-6"},$e={class:"flex items-center justify-between mb-6"},Se={class:"flex items-center gap-4"},De={class:"text-2xl font-bold text-gray-900"},Ee={class:"flex items-center gap-2"},Ne={key:0,class:"flex items-center justify-center py-20"},Te={key:1,class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},Re={class:"lg:col-span-2 space-y-6"},Oe={class:"bg-white rounded-lg border p-6"},Be={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},Le={class:"font-medium font-mono"},Ue={class:"font-medium"},Fe={class:"font-medium"},Pe={class:"font-medium"},Me={class:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4"},ze={class:"p-4 bg-blue-50 rounded-lg"},Qe={class:"text-2xl font-bold text-blue-800"},We={class:"p-4 bg-green-50 rounded-lg"},He={class:"text-2xl font-bold text-green-800"},Ke={class:"mt-4 p-4 border rounded-lg"},Ye={class:"flex items-center gap-3"},Ge={class:"font-medium"},Je={class:"text-sm text-gray-500"},Xe={class:"bg-white rounded-lg border p-6"},Ze={class:"space-y-4"},et={class:"p-3 bg-gray-50 rounded-lg"},tt={class:"p-3 bg-gray-50 rounded-lg whitespace-pre-wrap"},st={class:"grid grid-cols-2 gap-4"},at={class:"p-3 bg-gray-50 rounded-lg"},nt={class:"p-3 bg-gray-50 rounded-lg"},it={key:0,class:"bg-white rounded-lg border p-6"},ot={class:"space-y-4"},lt={class:"grid grid-cols-2 gap-4"},rt={class:"font-medium"},dt={class:"p-3 bg-gray-50 rounded-lg whitespace-pre-wrap"},ut={key:0,class:"p-4 border rounded-lg"},ct={class:"flex items-center justify-between"},vt={class:"flex items-center gap-3"},mt={class:"text-sm text-gray-500"},gt={class:"bg-white rounded-lg border p-6"},_t={class:"flex items-center justify-between mb-4"},pt={key:0,class:"grid grid-cols-2 md:grid-cols-3 gap-4"},yt={class:"flex items-center gap-3 mb-2"},ft={class:"text-sm font-medium truncate"},xt={class:"flex items-center gap-2"},bt={key:1,class:"text-center py-8 text-gray-500"},ht={class:"bg-white rounded-lg border p-6"},wt={key:0,class:"space-y-4"},kt={class:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0"},Ct={class:"flex-1"},Vt={class:"flex items-center gap-2 mb-1"},It={class:"font-medium text-sm"},jt={class:"text-xs text-gray-500"},qt={class:"text-sm text-gray-700"},At={key:1,class:"text-center py-4 text-gray-500"},$t={class:"mt-4 pt-4 border-t"},St={class:"flex gap-2"},Dt={class:"space-y-6"},Et={class:"bg-white rounded-lg border p-6"},Nt={class:"space-y-2"},Tt={class:"bg-white rounded-lg border p-6"},Rt={class:"space-y-3"},Ot={class:"flex items-center gap-2"},Bt={class:"text-sm text-gray-500 mt-1"},Lt={class:"flex items-center gap-2"},Ut={class:"text-sm text-gray-500 mt-1"},Ft={class:"bg-white rounded-lg border p-6"},Pt={class:"space-y-4"},Mt={class:"flex gap-3"},zt={class:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0"},Qt={class:"text-xs text-gray-500"},Wt={key:0,class:"flex gap-3"},Ht={class:"w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0"},Kt={class:"text-xs text-gray-500"},Yt={key:1,class:"flex gap-3"},Gt={class:"w-8 h-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0"},Jt={class:"text-xs text-gray-500"},ns={__name:"VarianceCaseDetail",setup(E){const c=ue(),_=ce(),C=j(!0),t=j(null),x=j([]),h=j([]),p=j("");ve(()=>f(this,null,function*(){yield Promise.all([v(),V(),N()])}));function v(){return f(this,null,function*(){C.value=!0;try{const a=yield k("frappe.client.get",{doctype:"Inventory Variance Case",name:c.params.id});t.value=a}catch(a){console.error("Error loading variance case:",a)}finally{C.value=!1}})}function V(){return f(this,null,function*(){try{const a=yield k("frappe.client.get_list",{doctype:"File",filters:{attached_to_doctype:"Inventory Variance Case",attached_to_name:c.params.id},fields:["name","file_name","file_url"]});x.value=a}catch(a){console.error("Error loading evidence:",a)}})}function N(){return f(this,null,function*(){try{const a=yield k("frappe.client.get_list",{doctype:"Comment",filters:{reference_doctype:"Inventory Variance Case",reference_name:c.params.id,comment_type:"Comment"},fields:["name","content","comment_by","creation"],order_by:"creation desc"});h.value=a}catch(a){console.error("Error loading comments:",a)}})}const F=q(()=>{var s;return{Open:"warning","Under Investigation":"outline",Resolved:"success","Written Off":"subtle",Closed:"subtle"}[(s=t.value)==null?void 0:s.status]||"subtle"}),P=q(()=>{var s;return{Critical:"solid",High:"warning",Medium:"outline",Low:"subtle"}[(s=t.value)==null?void 0:s.priority]||"subtle"}),T=q(()=>t.value?t.value.variance_qty<0?"bg-red-50":"bg-green-50":"bg-gray-50"),A=q(()=>t.value?t.value.variance_qty<0?"text-red-700":"text-green-700":"text-gray-700"),M=q(()=>t.value?t.value.variance_qty<0?"bg-red-100":"bg-green-100":"bg-gray-100");function $(a){return a?new Date(a).toLocaleDateString():"-"}function R(a){return a?new Date(a).toLocaleString():"-"}function z(a){return a==null?"-":new Intl.NumberFormat("en-KE",{style:"currency",currency:"KES"}).format(a)}function Q(a){return{Adjusted:"success","Written Off":"warning","No Action Required":"subtle",Transferred:"outline"}[a]||"subtle"}function W(a){return a?/\.(jpg|jpeg|png|gif|webp)$/i.test(a):!1}function H(){_.push("/inventory-audit/variance-cases")}function K(){_.push(`/inventory-audit/variance-cases/${c.params.id}/edit`)}function Y(){var a;(a=t.value)!=null&&a.stock_take_session&&_.push(`/inventory-audit/sessions/${t.value.stock_take_session}`)}function G(){var a;(a=t.value)!=null&&a.audit_plan&&_.push(`/inventory-audit/plans/${t.value.audit_plan}`)}function J(){var a;(a=t.value)!=null&&a.adjustment_entry&&window.open(`/app/stock-entry/${t.value.adjustment_entry}`,"_blank")}function X(){return f(this,null,function*(){try{yield k("frappe.client.set_value",{doctype:"Inventory Variance Case",name:c.params.id,fieldname:{status:"Under Investigation",investigation_start_date:new Date().toISOString().split("T")[0]}}),yield v()}catch(a){console.error("Error starting investigation:",a)}})}function Z(){return f(this,null,function*(){_.push(`/inventory-audit/variance-cases/${c.params.id}/resolve`)})}function ee(){window.open(`/app/stock-entry/new-stock-entry-1?from_variance_case=${c.params.id}`,"_blank")}function te(){return f(this,null,function*(){if(confirm("Are you sure you want to write off this variance?"))try{yield k("frappe.client.set_value",{doctype:"Inventory Variance Case",name:c.params.id,fieldname:{status:"Written Off",resolution_type:"Written Off",resolved_date:new Date().toISOString().split("T")[0]}}),yield v()}catch(a){console.error("Error writing off:",a)}})}function se(){console.log("Add evidence - implement file upload")}function ae(a){window.open(a.file_url,"_blank")}function ne(a){const s=document.createElement("a");s.href=a.file_url,s.download=a.file_name,s.click()}function ie(){return f(this,null,function*(){if(p.value.trim())try{yield k("frappe.client.insert",{doc:{doctype:"Comment",comment_type:"Comment",reference_doctype:"Inventory Variance Case",reference_name:c.params.id,content:p.value}}),p.value="",yield N()}catch(a){console.error("Error adding comment:",a)}})}function oe(){if(!t.value)return null;const a=Math.abs(t.value.variance_quantity*t.value.rate),s=t.value.variance_quantity>0,I=a>1e3;return{page_type:"variance-case",page_title:`Variance Case: ${t.value.name}`,item_code:t.value.item_code,item_name:t.value.item_name,warehouse:t.value.warehouse,branch:t.value.branch,status:t.value.status,priority:t.value.priority,system_quantity:t.value.system_quantity,physical_quantity:t.value.physical_quantity,variance_quantity:t.value.variance_quantity,variance_value:a,rate:t.value.rate,variance_type:s?"positive":"negative",is_high_value:I,reported_date:t.value.reported_date,investigation_status:t.value.investigation_status,root_cause:t.value.root_cause,corrective_action:t.value.corrective_action,responsible_person:t.value.responsible_person,target_resolution_date:t.value.target_resolution_date,actual_resolution_date:t.value.actual_resolution_date,evidence_count:x.value.length,comments_count:h.value.length,risk_assessment:{financial_impact:a,operational_impact:I?"high":"medium",urgency:t.value.priority==="High"?"high":t.value.priority==="Medium"?"medium":"low",likelihood_of_fraud:t.value.suspected_fraud?"high":"low"},investigation_details:{has_evidence:x.value.length>0,has_comments:h.value.length>0,has_root_cause:!!t.value.root_cause,has_corrective_action:!!t.value.corrective_action,is_overdue:t.value.target_resolution_date&&new Date(t.value.target_resolution_date)<new Date},summary:{description:`${s?"Positive":"Negative"} variance of ${Math.abs(t.value.variance_quantity)} units for ${t.value.item_name} in ${t.value.warehouse}`,key_findings:[`Variance Value: $${a.toFixed(2)}`,`Priority: ${t.value.priority}`,`Status: ${t.value.status}`,`Evidence Available: ${x.value.length} items`]}}}return(a,s)=>{var I;return l(),d("div",Ae,[e("div",$e,[e("div",Se,[o(n(m),{variant:"ghost",onClick:H},{default:u(()=>[o(n(me),{class:"w-5 h-5"})]),_:1}),e("div",null,[e("h1",De,i(((I=t.value)==null?void 0:I.name)||"Loading..."),1),s[1]||(s[1]=e("p",{class:"text-gray-500 mt-1"},"Inventory Variance Case",-1))])]),e("div",Ee,[o(n(S),{variant:F.value},{default:u(()=>{var r;return[y(i((r=t.value)==null?void 0:r.status),1)]}),_:1},8,["variant"]),o(n(S),{variant:P.value},{default:u(()=>{var r;return[y(i((r=t.value)==null?void 0:r.priority)+" Priority",1)]}),_:1},8,["variant"]),o(re,{contextType:"variance-case",contextData:oe()},null,8,["contextData"]),o(n(m),{variant:"outline",onClick:K},{default:u(()=>[o(n(ge),{class:"w-4 h-4 mr-2"}),s[2]||(s[2]=y(" Edit ",-1))]),_:1})])]),C.value?(l(),d("div",Ne,[...s[3]||(s[3]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"},null,-1)])])):t.value?(l(),d("div",Te,[e("div",Re,[e("div",Oe,[s[10]||(s[10]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Variance Details",-1)),e("div",Be,[e("div",null,[s[4]||(s[4]=e("span",{class:"text-sm text-gray-500"},"Item Code",-1)),e("p",Le,i(t.value.item_code),1)]),e("div",null,[s[5]||(s[5]=e("span",{class:"text-sm text-gray-500"},"Item Name",-1)),e("p",Ue,i(t.value.item_name||"-"),1)]),e("div",null,[s[6]||(s[6]=e("span",{class:"text-sm text-gray-500"},"Warehouse",-1)),e("p",Fe,i(t.value.warehouse||"-"),1)]),e("div",null,[s[7]||(s[7]=e("span",{class:"text-sm text-gray-500"},"Branch",-1)),e("p",Pe,i(t.value.branch||"-"),1)])]),e("div",Me,[e("div",ze,[s[8]||(s[8]=e("span",{class:"text-sm text-blue-700"},"System Qty",-1)),e("p",Qe,i(t.value.system_qty||0),1)]),e("div",We,[s[9]||(s[9]=e("span",{class:"text-sm text-green-700"},"Counted Qty",-1)),e("p",He,i(t.value.counted_qty||0),1)]),e("div",{class:w(["p-4 rounded-lg",T.value])},[e("span",{class:w(["text-sm",A.value])},"Variance Qty",2),e("p",{class:w(["text-2xl font-bold",A.value])},i(t.value.variance_qty>0?"+":"")+i(t.value.variance_qty||0),3)],2),e("div",{class:w(["p-4 rounded-lg",T.value])},[e("span",{class:w(["text-sm",A.value])},"Variance Value",2),e("p",{class:w(["text-2xl font-bold",A.value])},i(z(t.value.variance_value)),3)],2)]),e("div",Ke,[e("div",Ye,[e("div",{class:w(["w-10 h-10 rounded-full flex items-center justify-center",M.value])},[t.value.variance_qty<0?(l(),b(n(_e),{key:0,class:"w-5 h-5 text-red-600"})):(l(),b(n(pe),{key:1,class:"w-5 h-5 text-green-600"}))],2),e("div",null,[e("p",Ge,i(t.value.variance_qty<0?"Shortage":"Overage"),1),e("p",Je,i(Math.abs(t.value.variance_qty))+" units "+i(t.value.variance_qty<0?"less":"more")+" than system ",1)])])])]),e("div",Xe,[s[15]||(s[15]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Investigation",-1)),e("div",Ze,[e("div",null,[s[11]||(s[11]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Root Cause",-1)),e("div",et,i(t.value.root_cause||"Not yet determined"),1)]),e("div",null,[s[12]||(s[12]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Investigation Notes",-1)),e("div",tt,i(t.value.investigation_notes||"No investigation notes"),1)]),e("div",st,[e("div",null,[s[13]||(s[13]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Assigned Investigator",-1)),e("div",at,i(t.value.assigned_to||"Not assigned"),1)]),e("div",null,[s[14]||(s[14]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Due Date",-1)),e("div",nt,i($(t.value.due_date)||"Not set"),1)])])])]),t.value.status==="Resolved"||t.value.resolution_type?(l(),d("div",it,[s[21]||(s[21]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Resolution",-1)),e("div",ot,[e("div",lt,[e("div",null,[s[16]||(s[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Resolution Type",-1)),o(n(S),{variant:Q(t.value.resolution_type)},{default:u(()=>[y(i(t.value.resolution_type||"-"),1)]),_:1},8,["variant"])]),e("div",null,[s[17]||(s[17]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Resolved Date",-1)),e("p",rt,i($(t.value.resolved_date)||"-"),1)])]),e("div",null,[s[18]||(s[18]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Resolution Notes",-1)),e("div",dt,i(t.value.resolution_notes||"No resolution notes"),1)]),t.value.adjustment_entry?(l(),d("div",ut,[e("div",ct,[e("div",vt,[o(n(D),{class:"w-5 h-5 text-blue-600"}),e("div",null,[s[19]||(s[19]=e("p",{class:"font-medium"},"Stock Adjustment Entry",-1)),e("p",mt,i(t.value.adjustment_entry),1)])]),o(n(m),{variant:"outline",size:"sm",onClick:J},{default:u(()=>[o(n(ye),{class:"w-4 h-4 mr-1"}),s[20]||(s[20]=y(" View ",-1))]),_:1})])])):g("",!0)])])):g("",!0),e("div",gt,[e("div",_t,[s[23]||(s[23]=e("h3",{class:"text-lg font-semibold text-gray-900"},"Evidence & Attachments",-1)),o(n(m),{variant:"outline",size:"sm",onClick:se},{default:u(()=>[o(n(fe),{class:"w-4 h-4 mr-2"}),s[22]||(s[22]=y(" Add Evidence ",-1))]),_:1})]),x.value.length>0?(l(),d("div",pt,[(l(!0),d(O,null,B(x.value,r=>(l(),d("div",{key:r.name,class:"p-4 border rounded-lg"},[e("div",yt,[W(r.file_url)?(l(),b(n(xe),{key:0,class:"w-5 h-5 text-gray-500"})):(l(),b(n(D),{key:1,class:"w-5 h-5 text-gray-500"})),e("span",ft,i(r.file_name),1)]),e("div",xt,[o(n(m),{variant:"ghost",size:"sm",onClick:le=>ae(r)},{default:u(()=>[o(n(be),{class:"w-4 h-4"})]),_:1},8,["onClick"]),o(n(m),{variant:"ghost",size:"sm",onClick:le=>ne(r)},{default:u(()=>[o(n(he),{class:"w-4 h-4"})]),_:1},8,["onClick"])])]))),128))])):(l(),d("div",bt,[o(n(we),{class:"w-12 h-12 mx-auto mb-3 text-gray-300"}),s[24]||(s[24]=e("p",null,"No evidence attached yet",-1))]))]),e("div",ht,[s[26]||(s[26]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Activity",-1)),h.value.length>0?(l(),d("div",wt,[(l(!0),d(O,null,B(h.value,r=>(l(),d("div",{key:r.name,class:"flex gap-3"},[e("div",kt,[o(n(ke),{class:"w-4 h-4 text-blue-600"})]),e("div",Ct,[e("div",Vt,[e("span",It,i(r.comment_by),1),e("span",jt,i(R(r.creation)),1)]),e("p",qt,i(r.content),1)])]))),128))])):(l(),d("div",At,[...s[25]||(s[25]=[e("p",null,"No activity yet",-1)])])),e("div",$t,[e("div",St,[o(n(de),{type:"textarea",modelValue:p.value,"onUpdate:modelValue":s[0]||(s[0]=r=>p.value=r),placeholder:"Add a comment...",rows:2,class:"flex-1"},null,8,["modelValue"]),o(n(m),{variant:"solid",onClick:ie,disabled:!p.value.trim()},{default:u(()=>[o(n(Ce),{class:"w-4 h-4"})]),_:1},8,["disabled"])])])])]),e("div",Dt,[e("div",Et,[s[31]||(s[31]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Actions",-1)),e("div",Nt,[t.value.status==="Open"?(l(),b(n(m),{key:0,variant:"solid",class:"w-full justify-start",onClick:X},{default:u(()=>[o(n(L),{class:"w-4 h-4 mr-2"}),s[27]||(s[27]=y(" Start Investigation ",-1))]),_:1})):g("",!0),t.value.status==="Under Investigation"?(l(),b(n(m),{key:1,variant:"solid",class:"w-full justify-start",onClick:Z},{default:u(()=>[o(n(U),{class:"w-4 h-4 mr-2"}),s[28]||(s[28]=y(" Mark as Resolved ",-1))]),_:1})):g("",!0),t.value.status==="Under Investigation"?(l(),b(n(m),{key:2,variant:"outline",class:"w-full justify-start",onClick:ee},{default:u(()=>[o(n(D),{class:"w-4 h-4 mr-2"}),s[29]||(s[29]=y(" Create Stock Adjustment ",-1))]),_:1})):g("",!0),t.value.status==="Under Investigation"?(l(),b(n(m),{key:3,variant:"outline",class:"w-full justify-start text-orange-600",onClick:te},{default:u(()=>[o(n(Ve),{class:"w-4 h-4 mr-2"}),s[30]||(s[30]=y(" Write Off ",-1))]),_:1})):g("",!0)])]),e("div",Tt,[s[34]||(s[34]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Linked Documents",-1)),e("div",Rt,[t.value.stock_take_session?(l(),d("div",{key:0,class:"p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100",onClick:Y},[e("div",Ot,[o(n(Ie),{class:"w-4 h-4 text-gray-500"}),s[32]||(s[32]=e("span",{class:"text-sm font-medium"},"Stock Take Session",-1))]),e("p",Bt,i(t.value.stock_take_session),1)])):g("",!0),t.value.audit_plan?(l(),d("div",{key:1,class:"p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100",onClick:G},[e("div",Lt,[o(n(je),{class:"w-4 h-4 text-gray-500"}),s[33]||(s[33]=e("span",{class:"text-sm font-medium"},"Audit Plan",-1))]),e("p",Ut,i(t.value.audit_plan),1)])):g("",!0)])]),e("div",Ft,[s[38]||(s[38]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Timeline",-1)),e("div",Pt,[e("div",Mt,[e("div",zt,[o(n(qe),{class:"w-4 h-4 text-blue-600"})]),e("div",null,[s[35]||(s[35]=e("p",{class:"font-medium text-sm"},"Created",-1)),e("p",Qt,i(R(t.value.creation)),1)])]),t.value.investigation_start_date?(l(),d("div",Wt,[e("div",Ht,[o(n(L),{class:"w-4 h-4 text-yellow-600"})]),e("div",null,[s[36]||(s[36]=e("p",{class:"font-medium text-sm"},"Investigation Started",-1)),e("p",Kt,i($(t.value.investigation_start_date)),1)])])):g("",!0),t.value.resolved_date?(l(),d("div",Yt,[e("div",Gt,[o(n(U),{class:"w-4 h-4 text-green-600"})]),e("div",null,[s[37]||(s[37]=e("p",{class:"font-medium text-sm"},"Resolved",-1)),e("p",Jt,i($(t.value.resolved_date)),1)])])):g("",!0)])])])])):g("",!0)])}}};export{ns as default};
//# sourceMappingURL=VarianceCaseDetail-DJqXtma5.js.map
