var X=Object.defineProperty;var D=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var N=(m,i,u)=>i in m?X(m,i,{enumerable:!0,configurable:!0,writable:!0,value:u}):m[i]=u,R=(m,i)=>{for(var u in i||(i={}))Y.call(i,u)&&N(m,u,i[u]);if(D)for(var u of D(i))Z.call(i,u)&&N(m,u,i[u]);return m};var p=(m,i,u)=>new Promise((f,x)=>{var V=v=>{try{_(u.next(v))}catch(d){x(d)}},C=v=>{try{_(u.throw(v))}catch(d){x(d)}},_=v=>v.done?f(v.value):Promise.resolve(v.value).then(V,C);_((u=u.apply(m,i)).next())});import{g,a as k,b as r}from"./index-qIC3Tfxg.js";import{ap as ee,ab as te,r as c,j as h,Q as le,l as q,p as I,q as t,s as n,u as w,v as s,A as y,z as b,H as A,B as M}from"./vue-DciwFjI_.js";import{aL as ae,ad as P}from"./icons-CtLkBOsu.js";import"./charts-DlPBe6v3.js";import"./utils-Bcd7wHeW.js";const oe={class:"p-6"},se={class:"flex items-center justify-between mb-6"},ne={class:"flex items-center gap-4"},ie={class:"text-2xl font-bold text-gray-900"},re={class:"text-gray-500 mt-1"},ue={class:"flex items-center gap-2"},de={class:"max-w-4xl"},me={class:"space-y-6"},ve={class:"bg-white rounded-lg border p-6"},pe={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ge={class:"bg-white rounded-lg border p-6"},ce={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},ye={class:"bg-white rounded-lg border p-6"},be={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},fe={class:"bg-white rounded-lg border p-6"},_e={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},xe={class:"bg-white rounded-lg border p-6"},Ve={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ke={key:0,class:"bg-white rounded-lg border p-6"},we={class:"space-y-4"},Ce={key:1,class:"bg-white rounded-lg border p-6"},Ee={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ue={class:"md:col-span-2"},qe={class:"bg-white rounded-lg border p-6"},Ie={class:"flex items-center justify-end gap-3 mt-6 pt-6 border-t"},Ae={__name:"VarianceCaseForm",setup(m){const i=ee(),u=te(),f=c(!1),x=c([]),V=c([]),C=c([]),_=c([]),v=c([]),d=h(()=>i.params.id&&i.params.id!=="new"),l=c({item_code:"",item_name:"",warehouse:"",branch:"",system_qty:0,counted_qty:0,variance_qty:0,unit_cost:0,variance_value:0,uom:"Nos",status:"Open",priority:"Medium",category:"",stock_take_session:"",audit_plan:"",assigned_to:"",due_date:"",root_cause:"",investigation_notes:"",resolution_type:"",resolved_date:"",resolution_notes:"",notes:""}),O=h(()=>l.value.variance_qty===0?"bg-gray-100 text-gray-700":l.value.variance_qty<0?"bg-red-100 text-red-700":"bg-green-100 text-green-700");le(()=>p(this,null,function*(){yield Promise.all([T(),L(),W(),$(),B()]),d.value&&(yield j()),i.query.session&&(l.value.stock_take_session=i.query.session),i.query.item_code&&(l.value.item_code=i.query.item_code)}));function T(){return p(this,null,function*(){try{const a=yield g("frappe.client.get_list",{doctype:"User",filters:{enabled:1,user_type:"System User"},fields:["name","full_name"],limit_page_length:0});x.value=a.map(e=>({label:e.full_name||e.name,value:e.name}))}catch(a){console.error("Error loading users:",a)}})}function L(){return p(this,null,function*(){try{const a=yield g("frappe.client.get_list",{doctype:"Item",fields:["name","item_name","stock_uom","valuation_rate"],limit_page_length:0});V.value=a.map(e=>({label:`${e.name} - ${e.item_name}`,value:e.name,item_name:e.item_name,uom:e.stock_uom,cost:e.valuation_rate}))}catch(a){console.error("Error loading items:",a)}})}function W(){return p(this,null,function*(){try{const a=yield g("frappe.client.get_list",{doctype:"Warehouse",fields:["name","warehouse_name"],limit_page_length:0});C.value=a.map(e=>({label:e.warehouse_name||e.name,value:e.name}))}catch(a){console.error("Error loading warehouses:",a)}})}function $(){return p(this,null,function*(){try{const a=yield g("frappe.client.get_list",{doctype:"Stock Take Session",fields:["name","session_name","scheduled_date"],limit_page_length:50,order_by:"scheduled_date desc"});_.value=a.map(e=>({label:e.session_name||e.name,value:e.name}))}catch(a){console.error("Error loading sessions:",a)}})}function B(){return p(this,null,function*(){try{const a=yield g("frappe.client.get_list",{doctype:"Inventory Audit Plan",filters:{status:["in",["Planned","In Progress"]]},fields:["name","plan_title"],limit_page_length:0});v.value=a.map(e=>({label:e.plan_title||e.name,value:e.name}))}catch(a){console.error("Error loading audit plans:",a)}})}function j(){return p(this,null,function*(){try{const a=yield g("frappe.client.get",{doctype:"Inventory Variance Case",name:i.params.id});l.value={item_code:a.item_code||"",item_name:a.item_name||"",warehouse:a.warehouse||"",branch:a.branch||"",system_qty:a.system_qty||0,counted_qty:a.counted_qty||0,variance_qty:a.variance_qty||0,unit_cost:a.unit_cost||0,variance_value:a.variance_value||0,uom:a.uom||"Nos",status:a.status||"Open",priority:a.priority||"Medium",category:a.category||"",stock_take_session:a.stock_take_session||"",audit_plan:a.audit_plan||"",assigned_to:a.assigned_to||"",due_date:a.due_date||"",root_cause:a.root_cause||"",investigation_notes:a.investigation_notes||"",resolution_type:a.resolution_type||"",resolved_date:a.resolved_date||"",resolution_notes:a.resolution_notes||"",notes:a.notes||""}}catch(a){console.error("Error loading case:",a)}})}function Q(a){const e=V.value.find(o=>o.value===a);e&&(l.value.item_name=e.item_name,l.value.uom=e.uom||"Nos",l.value.unit_cost=e.cost||0,E())}function E(){l.value.variance_qty=(l.value.counted_qty||0)-(l.value.system_qty||0),l.value.variance_value=l.value.variance_qty*(l.value.unit_cost||0);const a=Math.abs(l.value.variance_value);a>1e5?l.value.priority="Critical":a>5e4?l.value.priority="High":a>1e4?l.value.priority="Medium":l.value.priority="Low"}function F(a){return a==null?"KES 0":new Intl.NumberFormat("en-KE",{style:"currency",currency:"KES"}).format(a)}function S(){return p(this,null,function*(){if(!l.value.item_code){alert("Item code is required");return}f.value=!0;try{if(d.value)yield g("frappe.client.set_value",{doctype:"Inventory Variance Case",name:i.params.id,fieldname:l.value}),u.push(`/inventory-audit/variance-cases/${i.params.id}`);else{const a=yield g("frappe.client.insert",{doc:R({doctype:"Inventory Variance Case"},l.value)});u.push(`/inventory-audit/variance-cases/${a.name}`)}}catch(a){console.error("Error saving case:",a),alert("Error saving case: "+a.message)}finally{f.value=!1}})}function U(){d.value?u.push(`/inventory-audit/variance-cases/${i.params.id}`):u.push("/inventory-audit/variance-cases")}const H=[{label:"Open",value:"Open"},{label:"Under Investigation",value:"Under Investigation"},{label:"Resolved",value:"Resolved"},{label:"Written Off",value:"Written Off"},{label:"Closed",value:"Closed"}],K=[{label:"Critical",value:"Critical"},{label:"High",value:"High"},{label:"Medium",value:"Medium"},{label:"Low",value:"Low"}],z=[{label:"Shortage",value:"Shortage"},{label:"Overage",value:"Overage"},{label:"Damaged",value:"Damaged"},{label:"Expired",value:"Expired"},{label:"Misplaced",value:"Misplaced"},{label:"Data Entry Error",value:"Data Entry Error"},{label:"Theft",value:"Theft"},{label:"Unknown",value:"Unknown"}],G=[{label:"Not Determined",value:""},{label:"Theft / Pilferage",value:"Theft / Pilferage"},{label:"Data Entry Error",value:"Data Entry Error"},{label:"Receiving Error",value:"Receiving Error"},{label:"Shipping Error",value:"Shipping Error"},{label:"Damage / Spoilage",value:"Damage / Spoilage"},{label:"Misplacement",value:"Misplacement"},{label:"System Error",value:"System Error"},{label:"Vendor Issue",value:"Vendor Issue"},{label:"Process Failure",value:"Process Failure"},{label:"Other",value:"Other"}],J=[{label:"Adjusted",value:"Adjusted"},{label:"Written Off",value:"Written Off"},{label:"No Action Required",value:"No Action Required"},{label:"Transferred",value:"Transferred"},{label:"Recovered",value:"Recovered"}];return(a,e)=>(I(),q("div",oe,[t("div",se,[t("div",ne,[n(s(k),{variant:"ghost",onClick:U},{default:w(()=>[n(s(ae),{class:"w-5 h-5"})]),_:1}),t("div",null,[t("h1",ie,y(d.value?"Edit Variance Case":"New Variance Case"),1),t("p",re,y(d.value?`Editing ${s(i).params.id}`:"Create a new inventory variance case"),1)])]),t("div",ue,[n(s(k),{variant:"outline",onClick:U},{default:w(()=>[...e[21]||(e[21]=[b("Cancel",-1)])]),_:1}),n(s(k),{variant:"solid",onClick:S,loading:f.value},{default:w(()=>[n(s(P),{class:"w-4 h-4 mr-2"}),b(" "+y(d.value?"Save Changes":"Create Case"),1)]),_:1},8,["loading"])])]),t("div",de,[t("div",me,[t("div",ve,[e[26]||(e[26]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Item Information",-1)),t("div",pe,[t("div",null,[e[22]||(e[22]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},[b(" Item Code "),t("span",{class:"text-red-500"},"*")],-1)),n(s(r),{type:"autocomplete",modelValue:l.value.item_code,"onUpdate:modelValue":e[0]||(e[0]=o=>l.value.item_code=o),options:V.value,placeholder:"Select or search item",onChange:Q},null,8,["modelValue","options"])]),t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Item Name",-1)),n(s(r),{type:"text",modelValue:l.value.item_name,"onUpdate:modelValue":e[1]||(e[1]=o=>l.value.item_name=o),placeholder:"Item name",readonly:!0},null,8,["modelValue"])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Warehouse",-1)),n(s(r),{type:"autocomplete",modelValue:l.value.warehouse,"onUpdate:modelValue":e[2]||(e[2]=o=>l.value.warehouse=o),options:C.value,placeholder:"Select warehouse"},null,8,["modelValue","options"])]),t("div",null,[e[25]||(e[25]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Branch",-1)),n(s(r),{type:"text",modelValue:l.value.branch,"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.branch=o),placeholder:"Branch location"},null,8,["modelValue"])])])]),t("div",ge,[e[33]||(e[33]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Variance Details",-1)),t("div",ce,[t("div",null,[e[27]||(e[27]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},[b(" System Qty "),t("span",{class:"text-red-500"},"*")],-1)),n(s(r),{type:"number",modelValue:l.value.system_qty,"onUpdate:modelValue":e[4]||(e[4]=o=>l.value.system_qty=o),placeholder:"0",onInput:E},null,8,["modelValue"])]),t("div",null,[e[28]||(e[28]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},[b(" Counted Qty "),t("span",{class:"text-red-500"},"*")],-1)),n(s(r),{type:"number",modelValue:l.value.counted_qty,"onUpdate:modelValue":e[5]||(e[5]=o=>l.value.counted_qty=o),placeholder:"0",onInput:E},null,8,["modelValue"])]),t("div",null,[e[29]||(e[29]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Variance Qty",-1)),t("div",{class:M(["p-2 rounded-lg font-medium text-center",O.value])},y(l.value.variance_qty>0?"+":"")+y(l.value.variance_qty||0),3)]),t("div",null,[e[30]||(e[30]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Unit Cost",-1)),n(s(r),{type:"number",modelValue:l.value.unit_cost,"onUpdate:modelValue":e[6]||(e[6]=o=>l.value.unit_cost=o),placeholder:"0.00",onInput:E},null,8,["modelValue"])]),t("div",null,[e[31]||(e[31]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Variance Value",-1)),t("div",{class:M(["p-2 rounded-lg font-medium text-center",O.value])},y(F(l.value.variance_value)),3)]),t("div",null,[e[32]||(e[32]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"UOM",-1)),n(s(r),{type:"text",modelValue:l.value.uom,"onUpdate:modelValue":e[7]||(e[7]=o=>l.value.uom=o),placeholder:"e.g., Nos, Kg"},null,8,["modelValue"])])])]),t("div",ye,[e[37]||(e[37]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Classification",-1)),t("div",be,[t("div",null,[e[34]||(e[34]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Status",-1)),n(s(r),{type:"select",modelValue:l.value.status,"onUpdate:modelValue":e[8]||(e[8]=o=>l.value.status=o),options:H},null,8,["modelValue"])]),t("div",null,[e[35]||(e[35]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Priority",-1)),n(s(r),{type:"select",modelValue:l.value.priority,"onUpdate:modelValue":e[9]||(e[9]=o=>l.value.priority=o),options:K},null,8,["modelValue"])]),t("div",null,[e[36]||(e[36]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Category",-1)),n(s(r),{type:"select",modelValue:l.value.category,"onUpdate:modelValue":e[10]||(e[10]=o=>l.value.category=o),options:z},null,8,["modelValue"])])])]),t("div",fe,[e[40]||(e[40]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Linked Documents",-1)),t("div",_e,[t("div",null,[e[38]||(e[38]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Stock Take Session",-1)),n(s(r),{type:"autocomplete",modelValue:l.value.stock_take_session,"onUpdate:modelValue":e[11]||(e[11]=o=>l.value.stock_take_session=o),options:_.value,placeholder:"Link to session"},null,8,["modelValue","options"])]),t("div",null,[e[39]||(e[39]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Audit Plan",-1)),n(s(r),{type:"autocomplete",modelValue:l.value.audit_plan,"onUpdate:modelValue":e[12]||(e[12]=o=>l.value.audit_plan=o),options:v.value,placeholder:"Link to audit plan"},null,8,["modelValue","options"])])])]),t("div",xe,[e[43]||(e[43]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Investigation Assignment",-1)),t("div",Ve,[t("div",null,[e[41]||(e[41]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Assigned To",-1)),n(s(r),{type:"autocomplete",modelValue:l.value.assigned_to,"onUpdate:modelValue":e[13]||(e[13]=o=>l.value.assigned_to=o),options:x.value,placeholder:"Assign investigator"},null,8,["modelValue","options"])]),t("div",null,[e[42]||(e[42]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Due Date",-1)),n(s(r),{type:"date",modelValue:l.value.due_date,"onUpdate:modelValue":e[14]||(e[14]=o=>l.value.due_date=o)},null,8,["modelValue"])])])]),d.value?(I(),q("div",ke,[e[46]||(e[46]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Investigation Details",-1)),t("div",we,[t("div",null,[e[44]||(e[44]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Root Cause",-1)),n(s(r),{type:"select",modelValue:l.value.root_cause,"onUpdate:modelValue":e[15]||(e[15]=o=>l.value.root_cause=o),options:G},null,8,["modelValue"])]),t("div",null,[e[45]||(e[45]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Investigation Notes",-1)),n(s(r),{type:"textarea",modelValue:l.value.investigation_notes,"onUpdate:modelValue":e[16]||(e[16]=o=>l.value.investigation_notes=o),placeholder:"Document investigation findings...",rows:4},null,8,["modelValue"])])])])):A("",!0),d.value&&(l.value.status==="Resolved"||l.value.status==="Written Off")?(I(),q("div",Ce,[e[50]||(e[50]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Resolution",-1)),t("div",Ee,[t("div",null,[e[47]||(e[47]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Resolution Type",-1)),n(s(r),{type:"select",modelValue:l.value.resolution_type,"onUpdate:modelValue":e[17]||(e[17]=o=>l.value.resolution_type=o),options:J},null,8,["modelValue"])]),t("div",null,[e[48]||(e[48]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Resolved Date",-1)),n(s(r),{type:"date",modelValue:l.value.resolved_date,"onUpdate:modelValue":e[18]||(e[18]=o=>l.value.resolved_date=o)},null,8,["modelValue"])]),t("div",Ue,[e[49]||(e[49]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Resolution Notes",-1)),n(s(r),{type:"textarea",modelValue:l.value.resolution_notes,"onUpdate:modelValue":e[19]||(e[19]=o=>l.value.resolution_notes=o),placeholder:"Document resolution details...",rows:3},null,8,["modelValue"])])])])):A("",!0),t("div",qe,[e[51]||(e[51]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Additional Notes",-1)),n(s(r),{type:"textarea",modelValue:l.value.notes,"onUpdate:modelValue":e[20]||(e[20]=o=>l.value.notes=o),placeholder:"Any additional notes...",rows:3},null,8,["modelValue"])])]),t("div",Ie,[n(s(k),{variant:"outline",onClick:U},{default:w(()=>[...e[52]||(e[52]=[b("Cancel",-1)])]),_:1}),n(s(k),{variant:"solid",onClick:S,loading:f.value},{default:w(()=>[n(s(P),{class:"w-4 h-4 mr-2"}),b(" "+y(d.value?"Save Changes":"Create Case"),1)]),_:1},8,["loading"])])])]))}};export{Ae as default};
//# sourceMappingURL=VarianceCaseForm-BuwpLbmy.js.map
