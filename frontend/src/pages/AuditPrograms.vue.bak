<template>
  <div class="space-y-6">
    <!-- Page Header with Enhanced Actions -->
    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
      <div>
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-purple-100 rounded-lg">
            <FileTextIcon class="h-6 w-6 text-purple-600" />
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Audit Programs</h1>
            <p class="text-gray-600 mt-1">
              Create and manage comprehensive audit programs with detailed procedures
            </p>
          </div>
        </div>
      </div>
      
      <div class="flex flex-wrap items-center gap-3">
        <!-- Action Buttons -->
        <div class="flex items-center space-x-2">
          <Button
            variant="outline"
            theme="gray"
            @click="exportPrograms"
            :disabled="auditPrograms.length === 0"
            class="border-gray-300 hover:border-gray-400"
          >
            <template #prefix>
              <DownloadIcon class="h-4 w-4" />
            </template>
            Export
          </Button>
          <Button
            variant="outline"
            theme="gray"
            @click="refreshData"
            :loading="loading"
            class="border-gray-300 hover:border-gray-400"
          >
            <template #prefix>
              <RefreshCwIcon class="h-4 w-4" />
            </template>
            Refresh
          </Button>
        </div>
        
        <!-- Primary Actions -->
        <div class="flex items-center space-x-2">
          <Button
            variant="outline"
            theme="purple"
            @click="createProgramFromTemplate"
            :disabled="templatePrograms.length === 0"
            class="border-purple-300 hover:border-purple-400 text-purple-700 hover:bg-purple-50"
          >
            <template #prefix>
              <CopyIcon class="h-4 w-4" />
            </template>
            Use Template
          </Button>
          <Button
            variant="solid"
            theme="purple"
            @click="showCreateModal = true"
            class="shadow-sm hover:shadow-md transition-shadow"
          >
            <template #prefix>
              <PlusIcon class="h-4 w-4" />
            </template>
            New Program
          </Button>
        </div>
      </div>
    </div>

    <!-- Notification Messages -->
    <div v-if="errorMessage" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-red-800">{{ errorMessage }}</p>
        </div>
        <div class="ml-auto pl-3">
          <div class="-mx-1.5 -my-1.5">
            <button
              @click="errorMessage = ''"
              class="inline-flex bg-red-50 rounded-md p-1.5 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-red-50 focus:ring-red-600"
            >
              <span class="sr-only">Dismiss</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div v-if="successMessage" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-green-800">{{ successMessage }}</p>
        </div>
        <div class="ml-auto pl-3">
          <div class="-mx-1.5 -my-1.5">
            <button
              @click="successMessage = ''"
              class="inline-flex bg-green-50 rounded-md p-1.5 text-green-500 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-green-50 focus:ring-green-600"
            >
              <span class="sr-only">Dismiss</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <!-- Left Section: Title and Search/Filters -->
        <div class="flex flex-wrap items-center gap-4">
          <h3 class="text-sm font-semibold text-gray-900">Quick Actions</h3>
          
          <!-- Search and Filter Controls -->
          <div class="flex items-center space-x-2">
            <div class="relative">
              <SearchIcon class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              <input
                v-model="searchQuery"
                type="text"
                class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm w-48"
                placeholder="Search programs..."
              />
            </div>
            
            <Select
              v-model="filterType"
              :options="typeFilterOptions"
              placeholder="All Types"
              class="min-w-36"
            />
            
            <Select
              v-model="filterTemplate"
              :options="templateFilterOptions"
              placeholder="All Programs"
              class="min-w-32"
            />
            
            <Select
              v-model="filterStatus"
              :options="statusFilterOptions"
              placeholder="All Statuses"
              class="min-w-32"
            />
          </div>
        </div>
        
        <!-- Center Section: Action Buttons -->
        <div class="flex items-center space-x-2">
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="bulkCreateTemplates"
              :disabled="selectedPrograms.length === 0"
            >
              <template #prefix>
                <LayersIcon class="h-3.5 w-3.5" />
              </template>
              Create Templates ({{ selectedPrograms.length }})
            </Button>
          </div>
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="viewMode = viewMode === 'table' ? 'cards' : 'table'"
            >
              <template #prefix>
                <component :is="viewMode === 'table' ? 'LayoutGridIcon' : 'TableIcon'" class="h-3.5 w-3.5" />
              </template>
              {{ viewMode === 'table' ? 'Card View' : 'Table View' }}
            </Button>
          </div>
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="exportPrograms"
              :disabled="auditPrograms.length === 0"
            >
              <template #prefix>
                <DownloadIcon class="h-3.5 w-3.5" />
              </template>
              Export
            </Button>
          </div>
        </div>
        
        <!-- Right Section: Results Count -->
        <div class="flex items-center space-x-2 text-sm text-gray-600">
          <span>Showing {{ filteredPrograms.length }} of {{ auditPrograms.length }} programs</span>
        </div>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div v-if="selectedPrograms.length > 0" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <span class="text-sm font-medium text-blue-900">
            {{ selectedPrograms.length }} program{{ selectedPrograms.length > 1 ? 's' : '' }} selected
          </span>
        </div>
        <div class="flex items-center space-x-2">
          <Button
            variant="outline"
            size="sm"
            @click="clearSelection"
          >
            Clear Selection
          </Button>
          <Button
            variant="outline"
            size="sm"
            @click="bulkDeletePrograms"
            class="text-red-600 hover:text-red-700"
          >
            <TrashIcon class="h-4 w-4 mr-2" />
            Delete Selected
          </Button>
        </div>
      </div>
    </div>

    <!-- Enhanced Stats Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
      <!-- Total Programs Card -->
      <div class="bg-blue-50 rounded-xl border border-blue-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-blue-700 uppercase tracking-wide">Total Programs</p>
            <p class="text-3xl font-bold text-blue-900 mt-1">{{ auditPrograms.length }}</p>
            <p class="text-xs text-blue-600 mt-1">{{ activePrograms.length }} active</p>
          </div>
          <div class="p-3 bg-blue-500 rounded-xl shadow-sm">
            <FileTextIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>

      <!-- Templates Card -->
      <div class="bg-green-50 rounded-xl border border-green-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-green-700 uppercase tracking-wide">Templates</p>
            <p class="text-3xl font-bold text-green-900 mt-1">{{ templatePrograms.length }}</p>
            <p class="text-xs text-green-600 mt-1">Reusable programs</p>
          </div>
          <div class="p-3 bg-green-500 rounded-xl shadow-sm">
            <CopyIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>

      <!-- Average Completion Card -->
      <div class="bg-purple-50 rounded-xl border border-purple-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-purple-700 uppercase tracking-wide">Avg Completion</p>
            <p class="text-3xl font-bold text-purple-900 mt-1">{{ averageCompletion }}%</p>
            <div class="w-full bg-purple-200 rounded-full h-2 mt-2">
              <div 
                class="bg-purple-600 h-2 rounded-full transition-all duration-300"
                :style="{ width: `${Math.min(averageCompletion, 100)}%` }"
              ></div>
            </div>
          </div>
          <div class="p-3 bg-purple-500 rounded-xl shadow-sm">
            <BarChartIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>

      <!-- Active Programs Card -->
      <div class="bg-yellow-50 rounded-xl border border-yellow-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-yellow-700 uppercase tracking-wide">Active Programs</p>
            <p class="text-3xl font-bold text-yellow-900 mt-1">{{ activePrograms.length }}</p>
            <p class="text-xs text-yellow-600 mt-1">In progress</p>
          </div>
          <div class="p-3 bg-yellow-500 rounded-xl shadow-sm">
            <PlayIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>

      <!-- Overdue Programs Card -->
      <div class="bg-red-50 rounded-xl border border-red-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-red-700 uppercase tracking-wide">Overdue</p>
            <p class="text-3xl font-bold text-red-900 mt-1">{{ overduePrograms.length }}</p>
            <p class="text-xs text-red-600 mt-1">Need attention</p>
          </div>
          <div class="p-3 bg-red-500 rounded-xl shadow-sm">
            <AlertTriangleIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>
    </div>

    <!-- Programs Display - Table or Card View -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Audit Programs</h3>
          <div class="flex items-center space-x-2">
            <div class="p-1" v-if="viewMode === 'table' && filteredPrograms.length > 0">
              <Button
                variant="solid"
                theme="gray"
                size="sm"
                @click="toggleSelectAll"
              >
                {{ selectAll ? 'Deselect All' : 'Select All' }}
              </Button>
            </div>
          </div>
        </div>
      </div>

      <!-- Table View -->
      <div v-if="viewMode === 'table'" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left">
                <Checkbox
                  v-model="selectAll"
                  @change="toggleSelectAll"
                />
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Program ID
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Name
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Type
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Template
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Progress
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Status
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr
              v-for="program in paginatedPrograms"
              :key="program.name"
              class="hover:bg-gray-50 transition-colors"
              :class="{ 'bg-purple-50': selectedPrograms.includes(program.name) }"
            >
              <td class="px-6 py-4 whitespace-nowrap">
                <Checkbox
                  :model-value="selectedPrograms.includes(program.name)"
                  @change="toggleProgramSelection(program.name)"
                />
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                {{ program.program_id }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <div class="flex-1">
                    <div class="font-medium">{{ program.program_name }}</div>
                    <div class="text-xs text-gray-500">
                      Created {{ formatDate(program.creation) }}
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <Badge :variant="getTypeVariant(program.audit_type)">
                  {{ program.audit_type }}
                </Badge>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <Badge
                  :variant="program.is_template ? 'success' : 'secondary'"
                  size="sm"
                >
                  {{ program.is_template ? 'Template' : 'Program' }}
                </Badge>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center space-x-2">
                  <div class="flex-1 bg-gray-200 rounded-full h-2">
                    <div
                      class="h-2 rounded-full transition-all duration-300"
                      :class="getProgressBarColor(program.completion_percent || 0)"
                      :style="{ width: `${program.completion_percent || 0}%` }"
                    ></div>
                  </div>
                  <div class="text-xs text-gray-500 min-w-0">{{ program.completion_percent || 0 }}%</div>
                </div>
                <div class="text-xs text-gray-400 mt-1">
                  {{ program.completed_procedures || 0 }}/{{ program.total_procedures || 0 }} procedures
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <Badge :variant="getStatusVariant(program.status || 'Draft')">
                  {{ program.status || 'Draft' }}
                </Badge>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center space-x-1">
                  <Button
                    variant="ghost"
                    size="sm"
                    @click="viewProgram(program)"
                    title="View Program"
                    class="!p-1.5"
                  >
                    <EyeIcon class="h-3.5 w-3.5" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    @click="editProgram(program)"
                    title="Edit Program"
                    class="!p-1.5"
                  >
                    <EditIcon class="h-3.5 w-3.5" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    @click="duplicateProgram(program)"
                    title="Duplicate Program"
                    class="!p-1.5"
                  >
                    <CopyIcon class="h-3.5 w-3.5" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    @click="useAsTemplate(program)"
                    v-if="!program.is_template"
                    title="Use as Template"
                    class="!p-1.5"
                  >
                    <CopyIcon class="h-3.5 w-3.5" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    @click="deleteProgram(program)"
                    class="text-red-600 hover:text-red-700 !p-1.5"
                    title="Delete Program"
                  >
                    <TrashIcon class="h-3.5 w-3.5" />
                  </Button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Card View -->
      <div v-else class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div
            v-for="program in paginatedPrograms"
            :key="program.name"
            class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200 cursor-pointer group"
            :class="{ 'ring-2 ring-purple-500 bg-purple-50': selectedPrograms.includes(program.name) }"
            @click="toggleProgramSelection(program.name)"
          >
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center space-x-3">
                <div class="h-12 w-12 rounded-xl bg-purple-500 flex items-center justify-center text-white font-bold">
                  {{ program.program_id?.charAt(0)?.toUpperCase() || 'P' }}
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-gray-900 group-hover:text-purple-900">{{ program.program_id }}</h3>
                  <p class="text-sm text-gray-600">{{ program.program_name }}</p>
                </div>
              </div>
              <Badge
                :variant="getStatusVariant(program.status || 'Draft')"
                size="sm"
                class="font-medium"
              >
                {{ program.status || 'Draft' }}
              </Badge>
            </div>

            <div class="space-y-3">
              <div>
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm text-gray-600">Progress</span>
                  <span class="text-sm font-medium">{{ program.completion_percent || 0 }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div
                    class="h-2 rounded-full transition-all duration-300"
                    :class="getProgressBarColor(program.completion_percent || 0)"
                    :style="{ width: `${program.completion_percent || 0}%` }"
                  ></div>
                </div>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Type</span>
                <Badge :variant="getTypeVariant(program.audit_type)" size="sm">
                  {{ program.audit_type }}
                </Badge>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Procedures</span>
                <span class="text-sm font-medium">{{ program.total_procedures || 0 }}</span>
              </div>
            </div>

            <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
              <div class="flex items-center space-x-1">
                <Button
                  variant="solid"
                  theme="gray"
                  size="sm"
                  @click.stop="viewProgram(program)"
                  class="!p-1.5"
                >
                  <EyeIcon class="h-3.5 w-3.5" />
                </Button>
                <Button
                  variant="solid"
                  theme="gray"
                  size="sm"
                  @click.stop="editProgram(program)"
                  class="!p-1.5"
                >
                  <EditIcon class="h-3.5 w-3.5" />
                </Button>
                <Button
                  variant="solid"
                  theme="gray"
                  size="sm"
                  @click.stop="duplicateProgram(program)"
                  class="!p-1.5"
                >
                  <CopyIcon class="h-3.5 w-3.5" />
                </Button>
              </div>
              <div class="text-xs text-gray-500">
                {{ formatDate(program.modified) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div v-if="filteredPrograms.length === 0 && auditPrograms.length === 0" class="px-6 py-20 text-center">
        <div class="mx-auto h-20 w-20 rounded-2xl bg-purple-50 border-2 border-purple-100 flex items-center justify-center mb-8 shadow-sm">
          <FileTextIcon class="h-10 w-10 text-purple-500" />
        </div>
        <div class="max-w-md mx-auto">
          <h3 class="text-2xl font-bold text-gray-900 mb-3">Welcome to Audit Programs</h3>
          <p class="text-gray-600 mb-8 leading-relaxed">
            Create comprehensive audit programs with detailed procedures and risk assessments. Build reusable templates for consistent audit execution.
          </p>
          <div class="flex flex-col sm:flex-row justify-center gap-3">
            <Button
              variant="solid"
              theme="purple"
              size="lg"
              @click="showCreateModal = true"
              class="shadow-sm hover:shadow-md transition-shadow"
            >
              <template #prefix>
                <PlusIcon class="h-5 w-5" />
              </template>
              Create Your First Program
            </Button>
            <Button
              variant="outline"
              theme="gray"
              size="lg"
              @click="createProgramFromTemplate"
              class="border-gray-300 hover:border-gray-400"
            >
              <template #prefix>
                <CopyIcon class="h-5 w-5" />
              </template>
              Browse Templates
            </Button>
          </div>
        </div>

        <!-- Quick Start Tips -->
        <div class="mt-12 max-w-2xl mx-auto">
          <div class="bg-gray-50 border border-gray-200 rounded-xl p-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <div class="h-2 w-2 bg-purple-500 rounded-full mr-3"></div>
              Quick Start Tips
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 h-6 w-6 bg-purple-100 rounded-lg flex items-center justify-center mt-0.5">
                  <span class="text-purple-600 font-semibold text-xs">1</span>
                </div>
                <div>
                  <p class="font-medium text-gray-900">Define Objectives</p>
                  <p class="text-gray-600">Set clear audit objectives and scope</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 h-6 w-6 bg-green-100 rounded-lg flex items-center justify-center mt-0.5">
                  <span class="text-green-600 font-semibold text-xs">2</span>
                </div>
                <div>
                  <p class="font-medium text-gray-900">Add Procedures</p>
                  <p class="text-gray-600">Create detailed audit procedures</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 h-6 w-6 bg-blue-100 rounded-lg flex items-center justify-center mt-0.5">
                  <span class="text-blue-600 font-semibold text-xs">3</span>
                </div>
                <div>
                  <p class="font-medium text-gray-900">Save as Template</p>
                  <p class="text-gray-600">Reuse programs across engagements</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No Results State -->
      <div v-else-if="filteredPrograms.length === 0" class="px-6 py-12 text-center">
        <SearchIcon class="mx-auto h-12 w-12 text-gray-400 mb-4" />
        <h3 class="text-lg font-medium text-gray-900 mb-2">No programs found</h3>
        <p class="text-gray-600 mb-6">
          Try adjusting your search or filter criteria to find the programs you're looking for.
        </p>
        <div class="p-1">
          <Button
            variant="solid"
            theme="gray"
            @click="clearAllFilters"
          >
            Clear Filters
          </Button>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div v-if="totalPages > 1" class="mt-6 px-6 py-4 bg-white border border-gray-200 rounded-xl shadow-sm flex items-center justify-between">
      <div class="text-sm text-gray-500">
        Showing {{ startIndex + 1 }} to {{ Math.min(endIndex, filteredPrograms.length) }} of {{ filteredPrograms.length }} programs
      </div>
      <div class="flex items-center space-x-2">
        <Button
          variant="outline"
          size="sm"
          @click="currentPage--"
          :disabled="currentPage === 1"
        >
          <ChevronLeftIcon class="h-4 w-4" />
        </Button>
        <span class="text-sm text-gray-700">
          Page {{ currentPage }} of {{ totalPages }}
        </span>
        <Button
          variant="outline"
          size="sm"
          @click="currentPage++"
          :disabled="currentPage === totalPages"
        >
          <ChevronRightIcon class="h-4 w-4" />
        </Button>
      </div>
    </div>

    <!-- View Program Modal -->
    <Dialog
      v-model="showViewModal"
      :title="viewingProgram?.program_name || 'Program Details'"
      size="6xl"
    >
      <template #body>
        <div v-if="viewingProgram" class="space-y-6">
          <!-- Program Header -->
          <div class="bg-gray-50 rounded-lg p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <h3 class="text-sm font-medium text-gray-500">Program ID</h3>
                <p class="text-lg font-semibold text-gray-900">{{ viewingProgram.program_id }}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500">Audit Type</h3>
                <Badge :variant="getTypeVariant(viewingProgram.audit_type)">
                  {{ viewingProgram.audit_type }}
                </Badge>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500">Status</h3>
                <Badge :variant="getStatusVariant(viewingProgram.status || 'Draft')">
                  {{ viewingProgram.status || 'Draft' }}
                </Badge>
              </div>
            </div>
          </div>

          <!-- Program Objectives -->
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-3">Program Objectives</h3>
            <div class="bg-white border border-gray-200 rounded-lg p-4">
              <p class="text-gray-700 whitespace-pre-wrap">{{ viewingProgram.program_objectives }}</p>
            </div>
          </div>

          <!-- Progress Summary -->
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-3">Progress Summary</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Total Procedures</p>
                    <p class="text-2xl font-bold text-gray-900">{{ viewingProgram.total_procedures || 0 }}</p>
                  </div>
                </div>
              </div>
              <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Completed</p>
                    <p class="text-2xl font-bold text-green-600">{{ viewingProgram.completed_procedures || 0 }}</p>
                  </div>
                </div>
              </div>
              <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Not Applicable</p>
                    <p class="text-2xl font-bold text-gray-500">{{ viewingProgram.not_applicable_procedures || 0 }}</p>
                  </div>
                </div>
              </div>
              <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Completion</p>
                    <p class="text-2xl font-bold text-blue-600">{{ viewingProgram.completion_percent || 0 }}%</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Audit Procedures -->
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-3">Audit Procedures</h3>
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Procedure</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr v-for="procedure in viewingProgram.program_procedures" :key="procedure.name">
                    <td class="px-6 py-4">
                      <div>
                        <div class="font-medium text-gray-900">{{ procedure.procedure_no }}</div>
                        <div class="text-sm text-gray-500">{{ procedure.procedure_description }}</div>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ procedure.procedure_type }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <Badge :variant="getProcedureStatusVariant(procedure.status)">
                        {{ procedure.status }}
                      </Badge>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ procedure.assigned_to }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Risk Areas -->
          <div v-if="viewingProgram.risk_areas && viewingProgram.risk_areas.length > 0">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Risk Areas</h3>
            <div class="space-y-4">
              <div v-for="risk in viewingProgram.risk_areas" :key="risk.name" class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="font-medium text-gray-900">{{ risk.risk_description }}</h4>
                  <Badge :variant="getRiskVariant(risk.risk_rating)">
                    {{ risk.risk_rating }}
                  </Badge>
                </div>
                <p class="text-sm text-gray-600 whitespace-pre-wrap">{{ risk.procedures_addressing_risk }}</p>
              </div>
            </div>
          </div>
        </div>
      </template>
      <template #footer>
        <div class="flex justify-end space-x-3">
          <Button variant="outline" @click="showViewModal = false">
            Close
          </Button>
          <Button
            @click="editProgram(viewingProgram)"
            class="bg-blue-600 hover:bg-blue-700 text-white"
          >
            Edit Program
          </Button>
        </div>
      </template>
    </Dialog>

    <!-- Create/Edit Program Modal -->
    <Dialog
      v-model="showCreateModal"
      :options="{
        title: editingProgram ? 'Edit Audit Program' : 'Create New Audit Program',
        size: '95vw',
        actions: []
      }"
      @close="resetForm"
    >
      <template #body>
        <div class="flex h-[90vh] bg-gray-50">
          <div class="flex-1 overflow-y-auto">
            <div class="p-8 space-y-8">
              <!-- Basic Information Section -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900">Basic Information</h3>
                  <p class="text-sm text-gray-600 mt-1">Enter the fundamental details of the audit program</p>
                </div>
                <div class="p-6 space-y-6">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Program ID -->
                    <FormControl
                      v-model="programForm.program_id"
                      label="Program ID"
                      placeholder="Enter program ID"
                      required
                      :disabled="editingProgram"
                    >
                      <template #suffix>
                        <Button
                          variant="ghost"
                          size="sm"
                          @click="generateProgramId"
                          :disabled="editingProgram"
                          class="text-purple-600 hover:text-purple-700"
                        >
                          Generate
                        </Button>
                      </template>
                    </FormControl>

                    <!-- Program Name -->
                    <FormControl
                      v-model="programForm.program_name"
                      label="Program Name"
                      placeholder="Enter program name"
                      required
                    />
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Audit Type -->
                    <FormControl label="Audit Type" required>
                      <Select
                        v-model="programForm.audit_type"
                        :options="auditTypeOptions"
                        placeholder="Select audit type"
                      />
                    </FormControl>

                    <!-- Is Template -->
                    <div class="flex items-center space-x-3">
                      <Checkbox
                        v-model="programForm.is_template"
                        :disabled="editingProgram"
                      />
                      <div>
                        <label class="text-sm font-medium text-gray-700">Save as Template</label>
                        <p class="text-xs text-gray-500">Templates can be reused for multiple engagements</p>
                      </div>
                    </div>
                  </div>

                  <!-- Engagement Reference (only for non-templates) -->
                  <FormControl
                    v-if="!programForm.is_template"
                    v-model="programForm.engagement_reference"
                    label="Engagement Reference"
                    placeholder="Link to specific engagement (optional)"
                  />
                </div>
              </div>

              <!-- Program Objectives Section -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900">Program Objectives</h3>
                  <p class="text-sm text-gray-600 mt-1">Define the goals and purpose of this audit program</p>
                </div>
                <div class="p-6">
                  <FormControl
                    v-model="programForm.program_objectives"
                    label="Program Objectives"
                    type="textarea"
                    placeholder="Describe the main objectives and goals of this audit program..."
                    required
                    :rows="4"
                  />
                </div>
              </div>

              <!-- Audit Procedures Section -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900">Audit Procedures</h3>
                    <p class="text-sm text-gray-600 mt-1">Define the detailed procedures and steps for this audit program</p>
                  </div>
                  <Button
                    variant="outline"
                    theme="purple"
                    @click="addProcedure"
                    class="border-purple-300 hover:border-purple-400 text-purple-700 hover:bg-purple-50"
                  >
                    <template #prefix>
                      <PlusIcon class="h-4 w-4" />
                    </template>
                    Add Procedure
                  </Button>
                </div>
                <div class="p-6">
                  <div v-if="programForm.program_procedures.length === 0" class="text-center py-8 text-gray-500">
                    <FileTextIcon class="h-12 w-12 mx-auto mb-4 text-gray-300" />
                    <p class="text-sm">No procedures added yet. Click "Add Procedure" to get started.</p>
                  </div>
                  <div v-else class="space-y-6">
                    <div
                      v-for="(procedure, index) in programForm.program_procedures"
                      :key="index"
                      class="border border-gray-200 rounded-lg p-6 bg-gray-50"
                    >
                      <div class="flex items-start justify-between mb-4">
                        <h4 class="text-md font-semibold text-gray-900">Procedure {{ index + 1 }}</h4>
                        <Button
                          variant="ghost"
                          size="sm"
                          @click="removeProcedure(index)"
                          class="text-red-600 hover:text-red-700 hover:bg-red-50"
                        >
                          <TrashIcon class="h-4 w-4" />
                        </Button>
                      </div>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <FormControl
                          v-model="procedure.procedure_no"
                          label="Procedure No."
                          placeholder="e.g., 1.1"
                        />
                        <FormControl
                          v-model="procedure.procedure_type"
                          label="Procedure Type"
                        >
                          <Select
                            v-model="procedure.procedure_type"
                            :options="procedureTypeOptions"
                            placeholder="Select type"
                          />
                        </FormControl>
                      </div>

                      <FormControl
                        v-model="procedure.procedure_description"
                        label="Procedure Description"
                        type="textarea"
                        placeholder="Describe the audit procedure..."
                        :rows="3"
                        class="mb-4"
                      />

                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <FormControl
                          v-model="procedure.control_objective"
                          label="Control Objective"
                          placeholder="What control objective does this address?"
                        />
                        <FormControl
                          v-model="procedure.assertion"
                          label="Assertion"
                        >
                          <Select
                            v-model="procedure.assertion"
                            :options="assertionOptions"
                            placeholder="Select assertion"
                          />
                        </FormControl>
                        <FormControl
                          v-model.number="procedure.budgeted_hours"
                          label="Budgeted Hours"
                          type="number"
                          placeholder="0"
                          min="0"
                          step="0.5"
                        />
                      </div>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <FormControl
                          v-model="procedure.status"
                          label="Status"
                        >
                          <Select
                            v-model="procedure.status"
                            :options="procedureStatusOptions"
                            placeholder="Select status"
                          />
                        </FormControl>
                        <FormControl
                          v-model="procedure.assigned_to"
                          label="Assigned To"
                          placeholder="Assign to team member"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Risk Areas Section -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900">Risk Areas</h3>
                    <p class="text-sm text-gray-600 mt-1">Identify and assess key risk areas associated with this audit program</p>
                  </div>
                  <Button
                    variant="outline"
                    theme="purple"
                    @click="addRiskArea"
                    class="border-purple-300 hover:border-purple-400 text-purple-700 hover:bg-purple-50"
                  >
                    <template #prefix>
                      <PlusIcon class="h-4 w-4" />
                    </template>
                    Add Risk Area
                  </Button>
                </div>
                <div class="p-6">
                  <div v-if="programForm.risk_areas.length === 0" class="text-center py-8 text-gray-500">
                    <AlertTriangleIcon class="h-12 w-12 mx-auto mb-4 text-gray-300" />
                    <p class="text-sm">No risk areas added yet. Click "Add Risk Area" to get started.</p>
                  </div>
                  <div v-else class="space-y-6">
                    <div
                      v-for="(risk, index) in programForm.risk_areas"
                      :key="index"
                      class="border border-gray-200 rounded-lg p-6 bg-gray-50"
                    >
                      <div class="flex items-start justify-between mb-4">
                        <h4 class="text-md font-semibold text-gray-900">Risk Area {{ index + 1 }}</h4>
                        <Button
                          variant="ghost"
                          size="sm"
                          @click="removeRiskArea(index)"
                          class="text-red-600 hover:text-red-700 hover:bg-red-50"
                        >
                          <TrashIcon class="h-4 w-4" />
                        </Button>
                      </div>

                      <FormControl
                        v-model="risk.risk_description"
                        label="Risk Description"
                        type="textarea"
                        placeholder="Describe the risk area..."
                        :rows="3"
                        class="mb-4"
                      />

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <FormControl
                          v-model="risk.risk_rating"
                          label="Risk Rating"
                        >
                          <Select
                            v-model="risk.risk_rating"
                            :options="riskRatingOptions"
                            placeholder="Select risk rating"
                          />
                        </FormControl>
                        <FormControl
                          v-model="risk.procedures_addressing_risk"
                          label="Procedures Addressing Risk"
                          type="textarea"
                          placeholder="Describe procedures that address this risk..."
                          :rows="3"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </template>

      <template #footer>
        <div class="bg-gray-50 px-8 py-6 border-t border-gray-200">
          <div class="flex items-center justify-between">
            <!-- Left side - Progress and Validation Status -->
            <div class="flex items-center space-x-6">
              <!-- Progress Indicator -->
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-white border-4 flex items-center justify-center relative"
                     :class="overallProgress === 100 ? 'border-green-500' : 'border-purple-500'">
                  <div class="absolute inset-0 rounded-full" 
                       :style="`conic-gradient(${overallProgress === 100 ? '#10b981' : '#8b5cf6'} ${overallProgress * 3.6}deg, #e5e7eb 0deg)`"></div>
                  <span class="relative text-sm font-bold" :class="overallProgress === 100 ? 'text-green-600' : 'text-purple-600'">
                    {{ overallProgress }}%
                  </span>
                </div>
                <div>
                  <div class="text-sm font-semibold text-gray-900">Form Progress</div>
                  <div class="text-xs text-gray-500">{{ getSectionStatus().filter(s => s.completed).length }} of {{ getSectionStatus().length }} sections completed</div>
                </div>
              </div>
              
              <!-- Validation Status -->
              <div class="flex items-center space-x-2">
                <div 
                  class="w-3 h-3 rounded-full flex-shrink-0"
                  :class="isFormValid ? 'bg-green-500' : 'bg-amber-500'"
                ></div>
                <span class="text-sm font-medium" :class="isFormValid ? 'text-green-700' : 'text-amber-700'">
                  {{ isFormValid ? 'All required fields completed' : 'Required fields missing' }}
                </span>
              </div>
            </div>
            
            <!-- Right side - Action Buttons -->
            <div class="flex items-center space-x-3">
              <!-- Cancel Button -->
              <Button
                variant="outline"
                theme="gray"
                @click="showCreateModal = false"
                class="border-gray-300 hover:border-gray-400"
                :disabled="saving || submitting"
              >
                Cancel
              </Button>
              
              <!-- Save as Draft Button -->
              <Button
                variant="outline"
                theme="purple"
                @click="saveDraft"
                :loading="saving"
                :disabled="submitting"
                class="border-purple-300 hover:border-purple-400 text-purple-700 hover:bg-purple-50"
              >
                <template #prefix v-if="!saving">
                  <FileTextIcon class="h-4 w-4" />
                </template>
                Save Draft
              </Button>
              
              <!-- Submit/Save Button -->
              <Button
                variant="solid"
                :theme="isFormValid ? 'green' : 'purple'"
                @click="isFormValid ? submitProgram() : saveProgram()"
                :loading="saving || submitting"
                class="shadow-sm hover:shadow-md transition-all"
              >
                <template #prefix v-if="!saving && !submitting">
                  <CheckCircleIcon class="h-4 w-4" v-if="isFormValid" />
                  <CheckIcon class="h-4 w-4" v-else />
                </template>
                {{ isFormValid ? (editingProgram ? 'Submit Changes' : 'Submit Program') : (editingProgram ? 'Update Program' : 'Save Program') }}
              </Button>
            </div>
          </div>
          
          <!-- Additional Info Bar -->
          <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
            <div class="flex items-center space-x-4">
              <span>Last saved: {{ lastSaved || 'Never' }}</span>
              <span v-if="programForm.program_id">Program ID: {{ programForm.program_id }}</span>
            </div>
            <div class="flex items-center space-x-2">
              <span>Procedures: {{ programForm.program_procedures.length }}</span>
              <div class="w-2 h-2 rounded-full bg-purple-400"></div>
            </div>
          </div>
        </div>
      </template>
    </Dialog>
  </div>
</template>

<script setup>
import { useAuditStore } from "@/stores/audit"
import { Badge, Button, Checkbox, Dialog, FormControl, Select } from "frappe-ui"
import { createResource } from "frappe-ui"
import {
	AlertTriangleIcon,
	BarChartIcon,
	CheckCircleIcon,
	CheckIcon,
	ChevronLeftIcon,
	ChevronRightIcon,
	CopyIcon,
	DownloadIcon,
	EditIcon,
	EyeIcon,
	FileTextIcon,
	LayersIcon,
	LayoutGridIcon,
	PlayIcon,
	PlusIcon,
	RefreshCwIcon,
	SearchIcon,
	TableIcon,
	TrashIcon,
	XIcon,
} from "lucide-vue-next"
import { computed, onMounted, onUnmounted, ref, watch } from "vue"
import { useRouter } from "vue-router"

const router = useRouter()
const auditStore = useAuditStore()

// Reactive state
const loading = ref(false)
const saving = ref(false)
const submitting = ref(false)
const lastSaved = ref(null)
const currentSection = ref(0)
const showCreateModal = ref(false)
const showViewModal = ref(false)
const editingProgram = ref(null)
const viewingProgram = ref(null)
const searchQuery = ref("")
const filterType = ref("")
const filterTemplate = ref("")
const filterStatus = ref("")
const selectedPrograms = ref([])
const selectAll = ref(false)
const currentPage = ref(1)
const pageSize = ref(10)
const errorMessage = ref("")
const successMessage = ref("")
const viewMode = ref("table") // 'table' or 'cards'

// Form sections for navigation
const formSections = ref([
	{
		id: "basic",
		title: "Basic Information",
		description: "Program ID, name, and type",
	},
	{
		id: "objectives",
		title: "Program Objectives",
		description: "Goals and purpose",
	},
	{
		id: "procedures",
		title: "Audit Procedures",
		description: "Detailed procedures and steps",
	},
	{ id: "risks", title: "Risk Areas", description: "Associated risk areas" },
])

// Form data
const programForm = ref({
	program_id: "",
	program_name: "",
	audit_type: "",
	is_template: false,
	engagement_reference: "",
	program_objectives: "",
	program_procedures: [],
	risk_areas: [],
})

// Options
const auditTypeOptions = [
	{ label: "Financial", value: "Financial" },
	{ label: "Operational", value: "Operational" },
	{ label: "Compliance", value: "Compliance" },
	{ label: "IT", value: "IT" },
	{ label: "Inventory", value: "Inventory" },
	{ label: "Cash", value: "Cash" },
	{ label: "Sales", value: "Sales" },
	{ label: "Procurement", value: "Procurement" },
]

const procedureTypeOptions = [
	{ label: "Inquiry", value: "Inquiry" },
	{ label: "Observation", value: "Observation" },
	{ label: "Inspection", value: "Inspection" },
	{ label: "Recalculation", value: "Recalculation" },
	{ label: "Reperformance", value: "Reperformance" },
	{ label: "Analytical Procedures", value: "Analytical Procedures" },
]

const riskAreaOptions = [
	{ label: "Financial Reporting", value: "Financial Reporting" },
	{ label: "Internal Controls", value: "Internal Controls" },
	{ label: "Compliance", value: "Compliance" },
	{ label: "Operations", value: "Operations" },
	{ label: "IT Security", value: "IT Security" },
	{ label: "Fraud Risk", value: "Fraud Risk" },
]

const typeFilterOptions = [
	{ label: "All Types", value: "" },
	...auditTypeOptions,
]

const templateFilterOptions = [
	{ label: "All Programs", value: "" },
	{ label: "Programs Only", value: "program" },
	{ label: "Templates Only", value: "template" },
]

const statusFilterOptions = [
	{ label: "All Statuses", value: "" },
	{ label: "Overdue", value: "overdue" },
	{ label: "In Progress", value: "in_progress" },
	{ label: "Completed", value: "completed" },
]

const procedureStatusOptions = [
	{ label: "Not Started", value: "Not Started" },
	{ label: "In Progress", value: "In Progress" },
	{ label: "Completed", value: "Completed" },
	{ label: "Not Applicable", value: "Not Applicable" },
]

const assertionOptions = [
	{ label: "Existence", value: "Existence" },
	{ label: "Completeness", value: "Completeness" },
	{ label: "Accuracy", value: "Accuracy" },
	{ label: "Valuation", value: "Valuation" },
	{ label: "Rights", value: "Rights" },
	{ label: "Presentation", value: "Presentation" },
	{ label: "Occurrence", value: "Occurrence" },
	{ label: "Cutoff", value: "Cutoff" },
]

const riskRatingOptions = [
	{ label: "Low", value: "Low" },
	{ label: "Medium", value: "Medium" },
	{ label: "High", value: "High" },
	{ label: "Critical", value: "Critical" },
]

// Computed properties
const auditPrograms = computed(() => auditStore.auditPrograms)
const templatePrograms = computed(() => auditStore.auditProgramTemplates)
const activePrograms = computed(() =>
	auditStore.auditPrograms.filter((p) => !p.is_template),
)

const averageCompletion = computed(() => {
	const programs = auditStore.auditPrograms.filter((p) => !p.is_template)
	if (programs.length === 0) return 0
	const total = programs.reduce(
		(sum, program) => sum + (program.completion_percent || 0),
		0,
	)
	return Math.round(total / programs.length)
})

const hasActiveFilters = computed(() => {
	return (
		searchQuery.value ||
		filterType.value ||
		filterTemplate.value ||
		filterStatus.value
	)
})

const isFormValid = computed(() => {
	return (
		programForm.value.program_id &&
		programForm.value.program_name &&
		programForm.value.audit_type &&
		programForm.value.program_objectives &&
		programForm.value.program_procedures.length > 0
	)
})

const overallProgress = computed(() => {
	let completed = 0
	const sections = getSectionStatus()
	sections.forEach((section) => {
		if (section.completed) completed++
	})
	return Math.round((completed / sections.length) * 100)
})

const filteredPrograms = computed(() => {
	let programs = auditStore.auditPrograms

	// Search filter
	if (searchQuery.value) {
		const query = searchQuery.value.toLowerCase()
		programs = programs.filter(
			(p) =>
				p.program_id?.toLowerCase().includes(query) ||
				p.program_name?.toLowerCase().includes(query) ||
				p.audit_type?.toLowerCase().includes(query),
		)
	}

	// Type filter
	if (filterType.value) {
		programs = programs.filter((p) => p.audit_type === filterType.value)
	}

	// Template filter
	if (filterTemplate.value === "template") {
		programs = programs.filter((p) => p.is_template)
	} else if (filterTemplate.value === "program") {
		programs = programs.filter((p) => !p.is_template)
	}

	// Status filter
	if (filterStatus.value) {
		const now = new Date()
		if (filterStatus.value === "overdue") {
			programs = programs.filter((p) => {
				if (!p.modified || p.is_template) return false
				const lastModified = new Date(p.modified)
				const daysSinceModified = (now - lastModified) / (1000 * 60 * 60 * 24)
				return daysSinceModified > 30 && (p.completion_percent || 0) < 100
			})
		} else if (filterStatus.value === "in_progress") {
			programs = programs.filter(
				(p) =>
					!p.is_template &&
					(p.completion_percent || 0) > 0 &&
					(p.completion_percent || 0) < 100,
			)
		} else if (filterStatus.value === "completed") {
			programs = programs.filter(
				(p) => !p.is_template && (p.completion_percent || 0) >= 100,
			)
		}
	}

	return programs
})

const paginatedPrograms = computed(() => {
	const start = (currentPage.value - 1) * pageSize.value
	const end = start + pageSize.value
	return filteredPrograms.value.slice(start, end)
})

const totalPages = computed(() => {
	return Math.ceil(filteredPrograms.value.length / pageSize.value)
})

const startIndex = computed(() => {
	return (currentPage.value - 1) * pageSize.value
})

const endIndex = computed(() => {
	return startIndex.value + pageSize.value
})

const overduePrograms = computed(() => {
	const now = new Date()
	return auditPrograms.value.filter((program) => {
		if (!program.modified) return false
		const lastModified = new Date(program.modified)
		const daysSinceModified = (now - lastModified) / (1000 * 60 * 60 * 24)
		return daysSinceModified > 30 && (program.completion_percent || 0) < 100
	})
})

// Methods
const clearAllFilters = () => {
	searchQuery.value = ""
	filterType.value = ""
	filterTemplate.value = ""
	filterStatus.value = ""
}

const generateProgramId = () => {
	const year = new Date().getFullYear()
	const type = programForm.value.audit_type
		? programForm.value.audit_type.substring(0, 3).toUpperCase()
		: "AUD"
	const random = Math.floor(Math.random() * 1000)
		.toString()
		.padStart(3, "0")
	programForm.value.program_id = `${type}-${year}-${random}`
}

const scrollToSection = (sectionIndex) => {
	currentSection.value = sectionIndex
	const element = document.querySelector(`[data-section="${sectionIndex}"]`)
	if (element) {
		element.scrollIntoView({ behavior: "smooth", block: "start" })
	}
}

const getSectionStatus = (sectionId) => {
	if (!sectionId) {
		return formSections.value.map((section) => ({
			id: section.id,
			completed: getSectionStatus(section.id).completed,
		}))
	}

	switch (sectionId) {
		case "basic":
			return {
				completed:
					programForm.value.program_id &&
					programForm.value.program_name &&
					programForm.value.audit_type,
			}
		case "objectives":
			return { completed: programForm.value.program_objectives }
		case "procedures":
			return { completed: programForm.value.program_procedures.length > 0 }
		case "risks":
			return { completed: true } // Optional section
		default:
			return { completed: false }
	}
}

const saveDraft = async () => {
	saving.value = true
	try {
		programForm.value.status = "Draft"

		if (editingProgram.value) {
			await auditStore.updateAuditProgram(
				editingProgram.value.name,
				programForm.value,
			)
		} else {
			await auditStore.createAuditProgram(programForm.value)
		}

		lastSaved.value = new Date().toLocaleTimeString()
		successMessage.value = "Program saved as draft successfully"
		await refreshData()
	} catch (error) {
		errorMessage.value = "Error saving draft: " + error.message
	} finally {
		saving.value = false
	}
}

const submitProgram = async () => {
	submitting.value = true
	try {
		programForm.value.status = "Active"

		if (editingProgram.value) {
			await auditStore.updateAuditProgram(
				editingProgram.value.name,
				programForm.value,
			)
		} else {
			await auditStore.createAuditProgram(programForm.value)
		}

		lastSaved.value = new Date().toLocaleTimeString()
		showCreateModal.value = false
		resetForm()
		successMessage.value = "Program submitted successfully"
		await refreshData()
	} catch (error) {
		errorMessage.value = "Error submitting program: " + error.message
	} finally {
		submitting.value = false
	}
}

const refreshData = async () => {
	loading.value = true
	errorMessage.value = ""
	try {
		await Promise.all([
			auditStore.fetchAuditPrograms(),
			auditStore.fetchEngagements(),
		])
	} catch (error) {
		console.error("Error refreshing data:", error)
		errorMessage.value = "Failed to refresh data. Please try again."
	} finally {
		loading.value = false
	}
}

const viewProgram = async (program) => {
	try {
		const programDetails = await auditStore.fetchAuditProgramDetails(
			program.name,
		)
		if (programDetails) {
			viewingProgram.value = programDetails
			showViewModal.value = true
		}
	} catch (error) {
		console.error("Error fetching program details:", error)
	}
}

const editProgram = (program) => {
	editingProgram.value = program
	// Load program data into form
	programForm.value = { ...program }
	showCreateModal.value = true
}

const duplicateProgram = async (program) => {
	try {
		const programDetails = await auditStore.fetchAuditProgramDetails(
			program.name,
		)
		if (programDetails) {
			editingProgram.value = null
			programForm.value = {
				...programDetails,
				program_id: `${programDetails.program_id}_copy`,
				program_name: `${programDetails.program_name} (Copy)`,
				is_template: false,
			}
			showCreateModal.value = true
		}
	} catch (error) {
		console.error("Error duplicating program:", error)
	}
}

const useAsTemplate = async (program) => {
	try {
		const programDetails = await auditStore.fetchAuditProgramDetails(
			program.name,
		)
		if (programDetails) {
			editingProgram.value = null
			programForm.value = {
				...programDetails,
				program_id: `${programDetails.program_id}_template`,
				program_name: `${programDetails.program_name} (Template)`,
				is_template: true,
				engagement_reference: "",
			}
			showCreateModal.value = true
		}
	} catch (error) {
		console.error("Error creating template:", error)
	}
}

const addProcedure = () => {
	programForm.value.program_procedures.push({
		procedure_no: "",
		procedure_description: "",
		procedure_type: "",
		control_objective: "",
		assertion: "",
		budgeted_hours: 0,
		status: "Not Started",
		assigned_to: "",
	})
}

const removeProcedure = (index) => {
	programForm.value.program_procedures.splice(index, 1)
}

const addRiskArea = () => {
	programForm.value.risk_areas.push({
		risk_description: "",
		risk_rating: "",
		procedures_addressing_risk: "",
	})
}

const removeRiskArea = (index) => {
	programForm.value.risk_areas.splice(index, 1)
}

const saveProgram = async () => {
	// Basic validation
	if (!programForm.value.program_id.trim()) {
		errorMessage.value = "Program ID is required"
		return
	}
	if (!programForm.value.program_name.trim()) {
		errorMessage.value = "Program Name is required"
		return
	}
	if (!programForm.value.audit_type) {
		errorMessage.value = "Audit Type is required"
		return
	}

	// Clear any previous messages
	errorMessage.value = ""
	successMessage.value = ""

	saving.value = true
	try {
		if (editingProgram.value) {
			await auditStore.updateAuditProgram(
				editingProgram.value.name,
				programForm.value,
			)
			successMessage.value = "Program updated successfully"
		} else {
			await auditStore.createAuditProgram(programForm.value)
			successMessage.value = "Program created successfully"
		}

		showCreateModal.value = false
		resetForm()
		await refreshData()

		// Clear success message after 3 seconds
		setTimeout(() => {
			successMessage.value = ""
		}, 3000)
	} catch (error) {
		console.error("Error saving program:", error)
		errorMessage.value =
			error.message || "Failed to save program. Please try again."
	} finally {
		saving.value = false
	}
}

const resetForm = () => {
	programForm.value = {
		program_id: "",
		program_name: "",
		audit_type: "",
		is_template: false,
		engagement_reference: "",
		program_objectives: "",
		program_procedures: [],
		risk_areas: [],
	}
	editingProgram.value = null
	errorMessage.value = ""
}

// Keyboard shortcuts
const handleKeydown = (event) => {
	// Ctrl/Cmd + N for new program
	if ((event.ctrlKey || event.metaKey) && event.key === "n") {
		event.preventDefault()
		showCreateModal.value = true
	}
	// Escape to close modals
	if (event.key === "Escape") {
		if (showCreateModal.value) {
			showCreateModal.value = false
			resetForm()
		} else if (showViewModal.value) {
			showViewModal.value = false
		}
	}
}

// New enhanced methods
const formatDate = (dateString) => {
	if (!dateString) return ""
	return new Date(dateString).toLocaleDateString()
}

const getTypeVariant = (type) => {
	const variants = {
		Financial: "primary",
		Operational: "secondary",
		Compliance: "warning",
		IT: "info",
		Inventory: "success",
		Cash: "danger",
		Sales: "primary",
		Procurement: "secondary",
	}
	return variants[type] || "secondary"
}

const getStatusVariant = (status) => {
	const variants = {
		Draft: "secondary",
		"In Progress": "warning",
		Completed: "success",
		Approved: "primary",
		Cancelled: "danger",
	}
	return variants[status] || "secondary"
}

const getProgressBarColor = (percentage) => {
	if (percentage >= 100) return "bg-green-500"
	if (percentage >= 75) return "bg-blue-500"
	if (percentage >= 50) return "bg-yellow-500"
	if (percentage >= 25) return "bg-orange-500"
	return "bg-red-500"
}

const getRiskVariant = (riskRating) => {
	const variants = {
		Low: "success",
		Medium: "warning",
		High: "danger",
		Critical: "danger",
	}
	return variants[riskRating] || "secondary"
}

const isOverdue = (program) => {
	if (program.is_template) return false
	const now = new Date()
	if (!program.modified) return false
	const lastModified = new Date(program.modified)
	const daysSinceModified = (now - lastModified) / (1000 * 60 * 60 * 24)
	return daysSinceModified > 30 && (program.completion_percent || 0) < 100
}

const toggleProgramSelection = (programId) => {
	const index = selectedPrograms.value.indexOf(programId)
	if (index > -1) {
		selectedPrograms.value.splice(index, 1)
	} else {
		selectedPrograms.value.push(programId)
	}
	selectAll.value =
		selectedPrograms.value.length === paginatedPrograms.value.length
}

const toggleSelectAll = () => {
	if (selectAll.value) {
		selectedPrograms.value = []
	} else {
		selectedPrograms.value = paginatedPrograms.value.map((p) => p.name)
	}
}

const clearSelection = () => {
	selectedPrograms.value = []
	selectAll.value = false
}

const deleteProgram = async (program) => {
	if (
		!confirm(
			`Are you sure you want to delete "${program.program_name}"? This action cannot be undone.`,
		)
	) {
		return
	}

	try {
		await createResource({
			url: "frappe.client.delete",
			params: {
				doctype: "Audit Program",
				name: program.name,
			},
		}).fetch()
		await refreshData()
	} catch (error) {
		console.error("Error deleting program:", error)
		alert("Failed to delete program. Please try again.")
	}
}

const bulkDeletePrograms = async () => {
	if (selectedPrograms.value.length === 0) return

	const count = selectedPrograms.value.length
	if (
		!confirm(
			`Are you sure you want to delete ${count} program${count > 1 ? "s" : ""}? This action cannot be undone.`,
		)
	) {
		return
	}

	try {
		for (const programId of selectedPrograms.value) {
			await createResource({
				url: "frappe.client.delete",
				params: {
					doctype: "Audit Program",
					name: programId,
				},
			}).fetch()
		}
		selectedPrograms.value = []
		selectAll.value = false
		await refreshData()
	} catch (error) {
		console.error("Error deleting programs:", error)
		alert("Failed to delete some programs. Please try again.")
	}
}

const bulkCreateTemplates = async () => {
	if (selectedPrograms.value.length === 0) return

	const count = selectedPrograms.value.length
	if (
		!confirm(
			`Create templates for ${count} selected program${count > 1 ? "s" : ""}?`,
		)
	) {
		return
	}

	try {
		for (const programId of selectedPrograms.value) {
			const program = auditPrograms.value.find((p) => p.name === programId)
			if (program && !program.is_template) {
				await useAsTemplate(program)
			}
		}
		selectedPrograms.value = []
		selectAll.value = false
		successMessage.value = `Created templates for ${count} program${count > 1 ? "s" : ""}`
		setTimeout(() => {
			successMessage.value = ""
		}, 3000)
	} catch (error) {
		console.error("Error creating templates:", error)
		errorMessage.value = "Failed to create some templates. Please try again."
	}
}

const createProgramFromTemplate = () => {
	// This would open a template selection modal
	// For now, just show the create modal with template option
	showCreateModal.value = true
}

const exportPrograms = () => {
	const data = filteredPrograms.value.map((program) => ({
		"Program ID": program.program_id,
		"Program Name": program.program_name,
		"Audit Type": program.audit_type,
		"Is Template": program.is_template ? "Yes" : "No",
		Status: program.status || "Draft",
		"Completion %": program.completion_percent || 0,
		Created: formatDate(program.creation),
		Modified: formatDate(program.modified),
	}))

	const csv = [
		Object.keys(data[0]).join(","),
		...data.map((row) =>
			Object.values(row)
				.map((val) => `"${val}"`)
				.join(","),
		),
	].join("\n")

	const blob = new Blob([csv], { type: "text/csv" })
	const url = window.URL.createObjectURL(blob)
	const a = document.createElement("a")
	a.href = url
	a.download = `audit-programs-${new Date().toISOString().split("T")[0]}.csv`
	a.click()
	window.URL.revokeObjectURL(url)
}

// Watchers
watch(filteredPrograms, () => {
	currentPage.value = 1
	selectedPrograms.value = []
	selectAll.value = false
})

watch(searchQuery, () => {
	currentPage.value = 1
})

watch(filterType, () => {
	currentPage.value = 1
})

watch(filterTemplate, () => {
	currentPage.value = 1
})

watch(filterStatus, () => {
	currentPage.value = 1
})

// Lifecycle
onMounted(async () => {
	await refreshData()
	// Add keyboard event listener
	document.addEventListener("keydown", handleKeydown)
})

onUnmounted(() => {
	// Remove keyboard event listener
	document.removeEventListener("keydown", handleKeydown)
})
</script>