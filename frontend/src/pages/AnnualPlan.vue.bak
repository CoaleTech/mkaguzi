<template>
  <div class="space-y-6">
    <!-- Page Header with Enhanced Actions -->
    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
      <div>
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-blue-100 rounded-lg">
            <CalendarIcon class="h-6 w-6 text-blue-600" />
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Annual Audit Plan</h1>
            <p class="text-gray-600 mt-1">
              Create and manage comprehensive annual audit planning with advanced tools
            </p>
          </div>
        </div>
      </div>
      
      <div class="flex flex-wrap items-center gap-3">
        <!-- Action Buttons -->
        <div class="flex items-center space-x-2">
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="exportPlans"
              :loading="exporting"
            >
              <template #prefix>
                <DownloadIcon class="h-3.5 w-3.5" />
              </template>
              Export
            </Button>
          </div>
          
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="showTemplateModal = true"
            >
              <template #prefix>
                <FileTextIcon class="h-3.5 w-3.5" />
              </template>
              Templates
            </Button>
          </div>
          
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="refreshData"
              :loading="loading"
            >
              <template #prefix>
                <RefreshCwIcon class="h-3.5 w-3.5" />
              </template>
              Refresh
            </Button>
          </div>
          
          <div class="p-1">
            <Button
              variant="solid"
              theme="blue"
              size="sm"
              @click="showCreateModal = true"
            >
              <template #prefix>
                <PlusIcon class="h-3.5 w-3.5" />
              </template>
              New Plan
            </Button>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Stats Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
      <!-- Active Plans Card -->
      <div class="bg-green-50 rounded-xl border border-green-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-green-700 uppercase tracking-wide">Active Plans</p>
            <p class="text-3xl font-bold text-green-900 mt-1">{{ activePlansCount }}</p>
            <p class="text-xs text-green-600 mt-1">{{ ((activePlansCount / Math.max(annualPlans.length, 1)) * 100).toFixed(0) }}% of total</p>
          </div>
          <div class="p-3 bg-green-500 rounded-xl shadow-sm">
            <CheckCircleIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>

      <!-- Planned Audits Card -->
      <div class="bg-blue-50 rounded-xl border border-blue-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-blue-700 uppercase tracking-wide">Planned Audits</p>
            <p class="text-3xl font-bold text-blue-900 mt-1">{{ plannedAuditsCount }}</p>
            <p class="text-xs text-blue-600 mt-1">Across all plans</p>
          </div>
          <div class="p-3 bg-blue-500 rounded-xl shadow-sm">
            <ClipboardListIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>

      <!-- Resource Utilization Card -->
      <div class="bg-amber-50 rounded-xl border border-amber-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-amber-700 uppercase tracking-wide">Avg Utilization</p>
            <p class="text-3xl font-bold text-amber-900 mt-1">{{ averageUtilization }}%</p>
            <div class="w-full bg-amber-200 rounded-full h-2 mt-2">
              <div 
                class="bg-amber-600 h-2 rounded-full transition-all duration-300"
                :style="{ width: `${Math.min(averageUtilization, 100)}%` }"
              ></div>
            </div>
          </div>
          <div class="p-3 bg-amber-500 rounded-xl shadow-sm">
            <UsersIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>

      <!-- Upcoming Audits Card -->
      <div class="bg-purple-50 rounded-xl border border-purple-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-purple-700 uppercase tracking-wide">Upcoming</p>
            <p class="text-3xl font-bold text-purple-900 mt-1">{{ upcomingAuditsCount }}</p>
            <p class="text-xs text-purple-600 mt-1">Next 30 days</p>
          </div>
          <div class="p-3 bg-purple-500 rounded-xl shadow-sm">
            <CalendarIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>

      <!-- Total Budget/Days Card -->
      <div class="bg-gray-50 rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Total Days</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{{ totalPlannedDays }}</p>
            <p class="text-xs text-gray-600 mt-1">Planned across all</p>
          </div>
          <div class="p-3 bg-gray-500 rounded-xl shadow-sm">
            <ClockIcon class="h-7 w-7 text-white" />
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <!-- Left Section: Title and Search/Filters -->
        <div class="flex flex-wrap items-center gap-4">
          <h3 class="text-sm font-semibold text-gray-900">Quick Actions</h3>
          
          <!-- Search and Filter Controls -->
          <div class="flex items-center space-x-2">
            <div class="relative">
              <SearchIcon class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              <input
                v-model="searchQuery"
                type="text"
                class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm w-48"
              />
            </div>
            
            <Select
              v-model="statusFilter"
              :options="[
                { label: 'All Status', value: '' },
                ...statusOptions
              ]"
        
              class="min-w-36"
            />
            
            <Select
              v-model="yearFilter"
              :options="[
                { label: 'All Years', value: '' },
                ...yearOptions
              ]"
              class="min-w-28"
            />
          </div>
        </div>
        
        <!-- Center Section: Action Buttons -->
        <div class="flex items-center space-x-2">
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="showBulkModal = true"
              :disabled="selectedPlans.length === 0"
            >
              <template #prefix>
                <LayersIcon class="h-3.5 w-3.5" />
              </template>
              Bulk Actions ({{ selectedPlans.length }})
            </Button>
          </div>
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="showCapacityModal = true"
            >
              <template #prefix>
                <BarChart3Icon class="h-3.5 w-3.5" />
              </template>
              Capacity Planning
            </Button>
          </div>
          <div class="p-1">
            <Button
              variant="solid"
              theme="gray"
              size="sm"
              @click="viewMode = viewMode === 'table' ? 'cards' : 'table'"
            >
              <template #prefix>
                <component :is="viewMode === 'table' ? 'LayoutGridIcon' : 'TableIcon'" class="h-3.5 w-3.5" />
              </template>
              {{ viewMode === 'table' ? 'Card View' : 'Table View' }}
            </Button>
          </div>
        </div>
        
        <!-- Right Section: Results Count -->
        <div class="flex items-center space-x-2 text-sm text-gray-600">
          <span>Showing {{ filteredPlans.length }} of {{ annualPlans.length }} plans</span>
        </div>
      </div>
    </div>

    <!-- Plans Display - Table or Card View -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Annual Audit Plans</h3>
          <div class="flex items-center space-x-2">
            <div class="p-1" v-if="viewMode === 'table' && filteredPlans.length > 0">
              <Button
                variant="solid"
                theme="gray"
                size="sm"
                @click="selectAllPlans"
              >
                {{ selectedPlans.length === filteredPlans.length ? 'Deselect All' : 'Select All' }}
              </Button>
            </div>
          </div>
        </div>
      </div>

      <!-- Table View -->
      <div v-if="viewMode === 'table'" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left">
                <input
                  type="checkbox"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  :checked="selectedPlans.length === filteredPlans.length && filteredPlans.length > 0"
                  @change="selectAllPlans"
                />
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  @click="sortBy('plan_id')">
                <div class="flex items-center space-x-1">
                  <span>Plan ID</span>
                  <ArrowUpDownIcon class="h-3 w-3" />
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  @click="sortBy('plan_year')">
                <div class="flex items-center space-x-1">
                  <span>Year</span>
                  <ArrowUpDownIcon class="h-3 w-3" />
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Status
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Progress
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Utilization
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Planned Audits
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr
              v-for="plan in filteredPlans"
              :key="plan.name"
              class="hover:bg-gray-50 transition-colors"
              :class="{ 'bg-blue-50': selectedPlans.includes(plan.name) }"
            >
              <td class="px-6 py-4">
                <input
                  type="checkbox"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  :checked="selectedPlans.includes(plan.name)"
                  @change="togglePlanSelection(plan.name)"
                />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-lg bg-blue-500 flex items-center justify-center text-white font-bold text-sm">
                      {{ plan.plan_year.toString().slice(-2) }}
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-semibold text-gray-900">{{ plan.plan_id }}</div>
                    <div class="text-sm text-gray-500">{{ plan.plan_period }}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{ plan.plan_year }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <Badge
                  :variant="getStatusVariant(plan.status)"
                  size="sm"
                  class="font-medium"
                >
                  {{ plan.status }}
                </Badge>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                    <div 
                      class="bg-blue-500 h-2 rounded-full transition-all duration-300"
                      :style="{ width: `${getPlanProgress(plan)}%` }"
                    ></div>
                  </div>
                  <span class="text-sm text-gray-600 min-w-0">{{ getPlanProgress(plan) }}%</span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="text-sm font-medium text-gray-900">{{ plan.utilization_percentage || 0 }}%</div>
                  <div class="ml-2 w-12 bg-gray-200 rounded-full h-1.5">
                    <div 
                      class="h-1.5 rounded-full transition-all duration-300"
                      :class="getUtilizationColor(plan.utilization_percentage || 0)"
                      :style="{ width: `${Math.min(plan.utilization_percentage || 0, 100)}%` }"
                    ></div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center space-x-2">
                  <span class="text-sm font-medium text-gray-900">{{ (plan.planned_audits || []).length }}</span>
                  <span class="text-xs text-gray-500">audits</span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center space-x-1">
                  <Button
                    variant="solid"
                    theme="gray"
                    size="sm"
                    @click="viewPlan(plan)"
                    class="!p-1.5"
                  >
                    <EyeIcon class="h-3.5 w-3.5" />
                  </Button>
                  <Button
                    variant="solid"
                    theme="gray"
                    size="sm"
                    @click="editPlan(plan)"
                    class="!p-1.5"
                  >
                    <EditIcon class="h-3.5 w-3.5" />
                  </Button>
                  <Button
                    variant="solid"
                    theme="gray"
                    size="sm"
                    @click="duplicatePlan(plan)"
                    class="!p-1.5"
                  >
                    <CopyIcon class="h-3.5 w-3.5" />
                  </Button>
                  <Button
                    variant="solid"
                    theme="gray"
                    size="sm"
                    @click="showPlanMenu(plan, $event)"
                    class="!p-1.5"
                  >
                    <MoreHorizontalIcon class="h-3.5 w-3.5" />
                  </Button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Card View -->
      <div v-else class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div
            v-for="plan in filteredPlans"
            :key="plan.name"
            class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200 cursor-pointer group"
            :class="{ 'ring-2 ring-blue-500 bg-blue-50': selectedPlans.includes(plan.name) }"
            @click="togglePlanSelection(plan.name)"
          >
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center space-x-3">
                <div class="h-12 w-12 rounded-xl bg-blue-500 flex items-center justify-center text-white font-bold">
                  {{ plan.plan_year.toString().slice(-2) }}
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-gray-900 group-hover:text-blue-900">{{ plan.plan_id }}</h3>
                  <p class="text-sm text-gray-600">{{ plan.plan_period }} Plan</p>
                </div>
              </div>
              <Badge
                :variant="getStatusVariant(plan.status)"
                size="sm"
                class="font-medium"
              >
                {{ plan.status }}
              </Badge>
            </div>

            <div class="space-y-3">
              <div>
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm text-gray-600">Progress</span>
                  <span class="text-sm font-medium">{{ getPlanProgress(plan) }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    class="bg-blue-500 h-2 rounded-full transition-all duration-300"
                    :style="{ width: `${getPlanProgress(plan)}%` }"
                  ></div>
                </div>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Utilization</span>
                <span class="text-sm font-medium">{{ plan.utilization_percentage || 0 }}%</span>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Planned Audits</span>
                <span class="text-sm font-medium">{{ (plan.planned_audits || []).length }}</span>
              </div>
            </div>

            <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
              <div class="flex items-center space-x-1">
                <Button
                  variant="solid"
                  theme="gray"
                  size="sm"
                  @click.stop="viewPlan(plan)"
                  class="!p-1.5"
                >
                  <EyeIcon class="h-3.5 w-3.5" />
                </Button>
                <Button
                  variant="solid"
                  theme="gray"
                  size="sm"
                  @click.stop="editPlan(plan)"
                  class="!p-1.5"
                >
                  <EditIcon class="h-3.5 w-3.5" />
                </Button>
                <Button
                  variant="solid"
                  theme="gray"
                  size="sm"
                  @click.stop="duplicatePlan(plan)"
                  class="!p-1.5"
                >
                  <CopyIcon class="h-3.5 w-3.5" />
                </Button>
              </div>
              <div class="text-xs text-gray-500">
                {{ formatDate(plan.modified) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div v-if="filteredPlans.length === 0 && annualPlans.length === 0" class="px-6 py-20 text-center">
        <div class="mx-auto h-20 w-20 rounded-2xl bg-blue-50 border-2 border-blue-100 flex items-center justify-center mb-8 shadow-sm">
          <CalendarIcon class="h-10 w-10 text-blue-500" />
        </div>
        <div class="max-w-md mx-auto">
          <h3 class="text-2xl font-bold text-gray-900 mb-3">Welcome to Annual Planning</h3>
          <p class="text-gray-600 mb-8 leading-relaxed">
            Create comprehensive annual audit plans with advanced planning tools. Set up your audit universe, allocate resources, and track planned activities.
          </p>
          <div class="flex flex-col sm:flex-row justify-center gap-3">
            <Button
              variant="solid"
              theme="blue"
              size="lg"
              @click="showCreateModal = true"
              class="shadow-sm hover:shadow-md transition-shadow"
            >
              <template #prefix>
                <PlusIcon class="h-5 w-5" />
              </template>
              Create Your First Plan
            </Button>
            <Button
              variant="outline"
              theme="gray"
              size="lg"
              @click="showTemplateModal = true"
              class="border-gray-300 hover:border-gray-400"
            >
              <template #prefix>
                <FileTextIcon class="h-5 w-5" />
              </template>
              Browse Templates
            </Button>
          </div>
        </div>
        
        <!-- Quick Start Tips -->
        <div class="mt-12 max-w-2xl mx-auto">
          <div class="bg-gray-50 border border-gray-200 rounded-xl p-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <div class="h-2 w-2 bg-blue-500 rounded-full mr-3"></div>
              Quick Start Tips
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 h-6 w-6 bg-blue-100 rounded-lg flex items-center justify-center mt-0.5">
                  <span class="text-blue-600 font-semibold text-xs">1</span>
                </div>
                <div>
                  <p class="font-medium text-gray-900">Define Objectives</p>
                  <p class="text-gray-600">Set clear audit objectives and scope</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 h-6 w-6 bg-green-100 rounded-lg flex items-center justify-center mt-0.5">
                  <span class="text-green-600 font-semibold text-xs">2</span>
                </div>
                <div>
                  <p class="font-medium text-gray-900">Allocate Resources</p>
                  <p class="text-gray-600">Plan team size and budget requirements</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 h-6 w-6 bg-purple-100 rounded-lg flex items-center justify-center mt-0.5">
                  <span class="text-purple-600 font-semibold text-xs">3</span>
                </div>
                <div>
                  <p class="font-medium text-gray-900">Schedule Audits</p>
                  <p class="text-gray-600">Create detailed audit timeline</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No Results State -->
      <div v-else-if="filteredPlans.length === 0" class="px-6 py-12 text-center">
        <SearchIcon class="mx-auto h-12 w-12 text-gray-400 mb-4" />
        <h3 class="text-lg font-medium text-gray-900 mb-2">No plans found</h3>
        <p class="text-gray-600 mb-6">
          Try adjusting your search or filter criteria to find the plans you're looking for.
        </p>
        <div class="p-1">
          <Button
            variant="solid"
            theme="gray"
            @click="clearFilters"
          >
            Clear Filters
          </Button>
        </div>
      </div>
    </div>

    <!-- Create/Edit Plan Modal -->
    <Dialog
      v-model="showCreateModal"
      :title="editingPlan ? 'Edit Annual Plan' : 'Create Annual Plan'"
      :options="{ size: 'full', width: '95vw', height: '90vh' }"
    >
      <template #body>
        <div class="h-[75vh] flex">
          <!-- Progress Sidebar -->
          <div class="w-72 bg-gray-50 border-r border-gray-200 flex-shrink-0">
            <div class="p-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-4">Progress</h4>
              <div class="space-y-3">
                <div 
                  v-for="(section, index) in formSections" 
                  :key="section.id"
                  class="flex items-center space-x-3 p-3 rounded-lg cursor-pointer transition-all"
                  :class="currentSection === index ? 'bg-blue-100 border border-blue-300' : 'hover:bg-gray-100'"
                  @click="scrollToSection(index)"
                >
                  <div 
                    class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-semibold"
                    :class="getSectionStatus(section.id) === 'complete' ? 'bg-green-500 text-white' : 
                             getSectionStatus(section.id) === 'partial' ? 'bg-amber-500 text-white' : 
                             'bg-gray-300 text-gray-600'"
                  >
                    <CheckIcon v-if="getSectionStatus(section.id) === 'complete'" class="h-3 w-3" />
                    <span v-else>{{ index + 1 }}</span>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900">{{ section.title }}</div>
                    <div class="text-xs text-gray-500">{{ section.description }}</div>
                  </div>
                </div>
              </div>
              
              <!-- Overall Progress -->
              <div class="mt-6 p-4 bg-white rounded-lg border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                  <span class="text-sm font-semibold text-blue-600">{{ overallProgress }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    class="bg-blue-600 h-2 rounded-full transition-all duration-500"
                    :style="{ width: `${overallProgress}%` }"
                  ></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Main Form Content -->
          <div class="flex-1 overflow-y-auto">
            <div class="p-8 space-y-12">
              <!-- Basic Information Section -->
              <div class="space-y-6" data-section="0">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                      <span class="text-white text-sm font-semibold">1</span>
                    </div>
                    <div>
                      <h3 class="text-xl font-bold text-gray-900">Basic Information</h3>
                      <p class="text-sm text-gray-500">Essential plan details and identification</p>
                    </div>
                  </div>
                  <div class="flex items-center space-x-2">
                    <Button
                      variant="outline"
                      theme="gray"
                      size="sm"
                      @click="generatePlanId"
                      :disabled="!!planForm.plan_id"
                    >
                      <template #prefix>
                        <RefreshCwIcon class="h-4 w-4" />
                      </template>
                      Auto-Generate ID
                    </Button>
                  </div>
                </div>
                
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8">
                  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    <FormControl
                      v-model="planForm.plan_id"
                      label="Plan ID"
                      placeholder="e.g., AP-2025-001"
                      :required="true"
                    />
                    <FormControl
                      v-model="planForm.plan_year"
                      type="number"
                      label="Plan Year"
                      :placeholder="new Date().getFullYear().toString()"
                      :required="true"
                      @input="updatePlanDates"
                    />
                    <Select
                      v-model="planForm.plan_period"
                      :options="periodOptions"
                      label="Plan Period"
                      placeholder="Select period"
                      @change="updatePlanDates"
                    />
                    <Select
                      v-model="planForm.status"
                      :options="statusOptions"
                      label="Status"
                      placeholder="Select status"
                    />
                  </div>

                <div class="mt-4 space-y-4">
                  <FormControl
                    v-model="planForm.plan_title"
                    label="Plan Title"
                    placeholder="Enter a descriptive title for this audit plan"
                    :required="true"
                  />
                  <FormControl
                    v-model="planForm.plan_description"
                    type="textarea"
                    label="Plan Description"
                    placeholder="Provide a comprehensive description of this audit plan"
                    rows="3"
                  />
                </div>
              </div>
            </div>

            <!-- Timeline & Dates -->
            <div class="space-y-4">
              <div class="flex items-center space-x-3 border-b border-gray-200 pb-2">
                <div class="h-2 w-2 bg-green-500 rounded-full"></div>
                <h4 class="text-lg font-semibold text-gray-900">Timeline & Dates</h4>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <FormControl
                  v-model="planForm.plan_start_date"
                  type="date"
                  label="Plan Start Date"
                  :required="true"
                />
                <FormControl
                  v-model="planForm.plan_end_date"
                  type="date"
                  label="Plan End Date"
                  :required="true"
                />
                <FormControl
                  v-model="planForm.submission_date"
                  type="date"
                  label="Submission Date"
                />
                <FormControl
                  v-model="planForm.approval_deadline"
                  type="date"
                  label="Approval Deadline"
                />
              </div>

            </div>

            <!-- Plan Overview -->
            <div class="space-y-4">
              <div class="flex items-center space-x-3 border-b border-gray-200 pb-2">
                <div class="h-2 w-2 bg-purple-500 rounded-full"></div>
                <h4 class="text-lg font-semibold text-gray-900">Plan Overview</h4>
              </div>
              
              <FormControl
                v-model="planForm.plan_objectives"
                type="textarea"
                label="Plan Objectives"
                placeholder="Enter the main objectives of this audit plan"
                rows="3"
                :required="true"
              />
              
              <FormControl
                v-model="planForm.scope_and_coverage"
                type="textarea"
                label="Scope and Coverage"
                placeholder="Describe the scope and coverage of audits"
                rows="3"
                :required="true"
              />
              
              <FormControl
                v-model="planForm.key_assumptions"
                type="textarea"
                label="Key Assumptions"
                placeholder="List key assumptions for this plan"
                rows="3"
              />

              <FormControl
                v-model="planForm.risk_factors"
                type="textarea"
                label="Risk Factors"
                placeholder="Identify potential risk factors that may impact plan execution"
                rows="3"
              />
            </div>

            <!-- Resources & Budget -->
            <div class="space-y-6" data-section="3">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center">
                    <span class="text-white text-sm font-semibold">4</span>
                  </div>
                  <div>
                    <h4 class="text-xl font-bold text-gray-900">Resources & Budget</h4>
                    <p class="text-sm text-gray-500">Budget allocation and resource planning</p>
                  </div>
                </div>
                <div class="bg-amber-50 rounded-lg px-3 py-2">
                  <div class="text-xs text-amber-600 font-medium">
                    Utilization: {{ planForm.utilization_percentage || 0 }}%
                  </div>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <FormControl
                  v-model="planForm.total_available_days"
                  type="number"
                  label="Total Available Days"
                  placeholder="0"
                  :required="true"
                />
                <FormControl
                  v-model="planForm.total_planned_days"
                  type="number"
                  label="Total Planned Days"
                  placeholder="0"
                />
                <FormControl
                  v-model="planForm.utilization_percentage"
                  type="number"
                  label="Utilization %"
                  placeholder="0"
                  readonly
                />
                <FormControl
                  v-model="planForm.team_size"
                  type="number"
                  label="Team Size"
                  placeholder="0"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <FormControl
                  v-model="planForm.total_budget"
                  type="number"
                  label="Total Budget"
                  placeholder="0"
                />
                <Select
                  v-model="planForm.currency"
                  :options="currencyOptions"
                  label="Currency"
                  placeholder="Select currency"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">External Resources Required</label>
                  <input
                    v-model="planForm.external_resources_required"
                    type="checkbox"
                    class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  />
                  <span class="ml-2 text-sm text-gray-600">Require external consultants or specialists</span>
                </div>
                <FormControl
                  v-if="planForm.external_resources_required"
                  v-model="planForm.external_budget"
                  type="number"
                  label="External Budget"
                  placeholder="0"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Required Skills</label>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                  <label
                    v-for="skill in skillOptions"
                    :key="skill.value"
                    class="flex items-center space-x-2 p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                  >
                    <input
                      type="checkbox"
                      :value="skill.value"
                      v-model="planForm.required_skills"
                      class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    />
                    <span class="text-sm text-gray-700">{{ skill.label }}</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Approval & Governance -->
            <div class="space-y-6" data-section="4">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center">
                    <span class="text-white text-sm font-semibold">5</span>
                  </div>
                  <div>
                    <h4 class="text-xl font-bold text-gray-900">Approval & Governance</h4>
                    <p class="text-sm text-gray-500">Approval workflow and governance</p>
                  </div>
                </div>
                <!-- Workflow Progress -->
                <div class="flex items-center space-x-2">
                  <div class="text-xs text-gray-500">Workflow</div>
                  <div class="flex items-center space-x-1">
                    <div class="w-2 h-2 rounded-full" :class="planForm.prepared_by ? 'bg-green-400' : 'bg-gray-300'"></div>
                    <div class="w-4 h-px bg-gray-300"></div>
                    <div class="w-2 h-2 rounded-full" :class="planForm.reviewed_by ? 'bg-green-400' : 'bg-gray-300'"></div>
                    <div class="w-4 h-px bg-gray-300"></div>
                    <div class="w-2 h-2 rounded-full" :class="planForm.approved_by ? 'bg-green-400' : 'bg-gray-300'"></div>
                  </div>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <FormControl
                  v-model="planForm.prepared_by"
                  label="Prepared By"
                  placeholder="Name of preparer"
                />
                <FormControl
                  v-model="planForm.reviewed_by"
                  label="Reviewed By"
                  placeholder="Name of reviewer"
                />
                <FormControl
                  v-model="planForm.approved_by"
                  label="Approved By"
                  placeholder="Name of approver"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Board Approval Required</label>
                  <input
                    v-model="planForm.board_approval_required"
                    type="checkbox"
                    class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  />
                  <span class="ml-2 text-sm text-gray-600">Requires board approval</span>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Audit Committee Review</label>
                  <input
                    v-model="planForm.audit_committee_review"
                    type="checkbox"
                    class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  />
                  <span class="ml-2 text-sm text-gray-600">Requires audit committee review</span>
                </div>
              </div>
            </div>

            <!-- Risk & Compliance -->
            <div class="space-y-6" data-section="5">
              <div class="flex items-center space-x-3">
                <div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center">
                  <span class="text-white text-sm font-semibold">6</span>
                </div>
                <div>
                  <h4 class="text-xl font-bold text-gray-900">Risk & Compliance</h4>
                  <p class="text-sm text-gray-500">Risk assessment and compliance frameworks</p>
                </div>
              </div>
              
              <FormControl
                v-model="planForm.regulatory_requirements"
                type="textarea"
                label="Regulatory Requirements"
                placeholder="List applicable regulatory requirements"
                rows="3"
              />

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Compliance Frameworks</label>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                  <label
                    v-for="framework in complianceFrameworkOptions"
                    :key="framework.value"
                    class="flex items-center space-x-2 p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                  >
                    <input
                      type="checkbox"
                      :value="framework.value"
                      v-model="planForm.compliance_frameworks"
                      class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    />
                    <span class="text-sm text-gray-700">{{ framework.label }}</span>
                  </label>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <FormControl
                  v-model="planForm.risk_assessment"
                  type="textarea"
                  label="Risk Assessment"
                  placeholder="Summary of risk assessment methodology"
                  rows="3"
                />
                <FormControl
                  v-model="planForm.materiality_threshold"
                  type="number"
                  label="Materiality Threshold"
                  placeholder="0"
                />
              </div>
            </div>

            <!-- Quality & Standards -->
            <div class="space-y-4">
              <div class="flex items-center space-x-3 border-b border-gray-200 pb-2">
                <div class="h-2 w-2 bg-indigo-500 rounded-full"></div>
                <h4 class="text-lg font-semibold text-gray-900">Quality & Standards</h4>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Audit Standards</label>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                  <label
                    v-for="standard in auditStandardOptions"
                    :key="standard.value"
                    class="flex items-center space-x-2 p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                  >
                    <input
                      type="checkbox"
                      :value="standard.value"
                      v-model="planForm.audit_standards"
                      class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    />
                    <span class="text-sm text-gray-700">{{ standard.label }}</span>
                  </label>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <FormControl
                  v-model="planForm.quality_control_measures"
                  type="textarea"
                  label="Quality Control Measures"
                  placeholder="Describe quality control measures"
                  rows="3"
                />
                <div class="flex items-center">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Peer Review Required</label>
                    <input
                      v-model="planForm.peer_review_required"
                      type="checkbox"
                      class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    />
                    <span class="ml-2 text-sm text-gray-600">Require peer review for audits</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Performance & Metrics -->
            <div class="space-y-4">
              <div class="flex items-center space-x-3 border-b border-gray-200 pb-2">
                <div class="h-2 w-2 bg-pink-500 rounded-full"></div>
                <h4 class="text-lg font-semibold text-gray-900">Performance & Metrics</h4>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <FormControl
                  v-model="planForm.success_criteria"
                  type="textarea"
                  label="Success Criteria"
                  placeholder="Define success criteria for this plan"
                  rows="3"
                />
                <FormControl
                  v-model="planForm.target_coverage"
                  type="number"
                  label="Target Coverage %"
                  placeholder="0"
                  min="0"
                  max="100"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Key Performance Indicators</label>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                  <label
                    v-for="kpi in kpiOptions"
                    :key="kpi.value"
                    class="flex items-center space-x-2 p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                  >
                    <input
                      type="checkbox"
                      :value="kpi.value"
                      v-model="planForm.kpis"
                      class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    />
                    <span class="text-sm text-gray-700">{{ kpi.label }}</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Communication & Reporting -->
            <div class="space-y-4">
              <div class="flex items-center space-x-3 border-b border-gray-200 pb-2">
                <div class="h-2 w-2 bg-teal-500 rounded-full"></div>
                <h4 class="text-lg font-semibold text-gray-900">Communication & Reporting</h4>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Select
                  v-model="planForm.reporting_frequency"
                  :options="reportingFrequencyOptions"
                  label="Reporting Frequency"
                  placeholder="Select frequency"
                />
              </div>

              <div class="grid grid-cols-1 gap-6">
                <FormControl
                  v-model="planForm.stakeholder_communication_plan"
                  type="textarea"
                  label="Stakeholder Communication Plan"
                  placeholder="Describe the communication plan with stakeholders"
                  rows="3"
                />
                <FormControl
                  v-model="planForm.escalation_procedures"
                  type="textarea"
                  label="Escalation Procedures"
                  placeholder="Define escalation procedures for issues"
                  rows="3"
                />
              </div>
            </div>

            <!-- Planned Audits -->
            <div class="space-y-4">
              <div class="flex items-center justify-between border-b border-gray-200 pb-2">
                <div class="flex items-center space-x-3">
                  <div class="h-2 w-2 bg-emerald-500 rounded-full"></div>
                  <h4 class="text-lg font-semibold text-gray-900">Planned Audits</h4>
                </div>
                <div class="p-1">
                  <Button
                    variant="solid"
                    theme="gray"
                    size="sm"
                    @click="addPlannedAudit"
                  >
                    <template #prefix>
                      <PlusIcon class="h-3.5 w-3.5" />
                    </template>
                    Add Audit
                  </Button>
                </div>
              </div>

              <div class="space-y-4 max-h-96 overflow-y-auto">
                <div
                  v-for="(audit, index) in planForm.planned_audits"
                  :key="index"
                  class="border border-gray-200 rounded-lg p-4 bg-gray-50"
                >
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <Select
                    v-model="audit.audit_universe"
                    :options="auditUniverseOptions"
                    label="Audit Universe"
                    placeholder="Select universe"
                  />
                  <Select
                    v-model="audit.audit_type"
                    :options="auditTypeOptions"
                    label="Audit Type"
                    placeholder="Select type"
                  />
                  <Select
                    v-model="audit.priority"
                    :options="priorityOptions"
                    label="Priority"
                    placeholder="Select priority"
                  />
                  <FormControl
                    v-model="audit.planned_days"
                    type="number"
                    label="Planned Days"
                    placeholder="0"
                  />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <FormControl
                    v-model="audit.planned_start_date"
                    type="date"
                    label="Start Date"
                  />
                  <FormControl
                    v-model="audit.planned_end_date"
                    type="date"
                    label="End Date"
                  />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <FormControl
                    v-model="audit.lead_auditor"
                    label="Lead Auditor"
                    placeholder="Select auditor"
                  />
                  <FormControl
                    v-model="audit.objectives"
                    type="textarea"
                    label="Objectives"
                    placeholder="Audit objectives"
                    rows="2"
                  />
                </div>

                <div class="flex justify-end mt-4">
                  <Button
                    variant="solid"
                    theme="red"
                    size="sm"
                    @click="removePlannedAudit(index)"
                    class="!p-1.5"
                  >
                    <TrashIcon class="h-3.5 w-3.5" />
                  </Button>
                </div>
              </div>

              <div v-if="planForm.planned_audits.length === 0" class="text-center py-12 text-gray-500">
                <div class="text-sm">No planned audits added yet</div>
                <div class="text-xs mt-1">Click "Add Audit" to start planning audits</div>
              </div>
            </div>
          </div>
        </div>
        </div>
        </div>
      </template>

      <template #footer>
        <div class="bg-gray-50 px-8 py-6 border-t border-gray-200">
          <div class="flex items-center justify-between">
            <!-- Left side - Progress and Validation Status -->
            <div class="flex items-center space-x-6">
              <!-- Progress Indicator -->
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-white border-4 flex items-center justify-center relative"
                     :class="overallProgress === 100 ? 'border-green-500' : 'border-blue-500'">
                  <div class="absolute inset-0 rounded-full" 
                       :style="`conic-gradient(${overallProgress === 100 ? '#10b981' : '#3b82f6'} ${overallProgress * 3.6}deg, #e5e7eb 0deg)`"></div>
                  <span class="relative text-sm font-bold" :class="overallProgress === 100 ? 'text-green-600' : 'text-blue-600'">
                    {{ overallProgress }}%
                  </span>
                </div>
                <div>
                  <div class="text-sm font-semibold text-gray-900">Form Progress</div>
                  <div class="text-xs text-gray-500">{{ getSectionStatus().filter(s => s.completed).length }} of {{ getSectionStatus().length }} sections completed</div>
                </div>
              </div>
              
              <!-- Validation Status -->
              <div class="flex items-center space-x-2">
                <div 
                  class="w-3 h-3 rounded-full flex-shrink-0"
                  :class="isFormValid ? 'bg-green-500' : 'bg-amber-500'"
                ></div>
                <span class="text-sm font-medium" :class="isFormValid ? 'text-green-700' : 'text-amber-700'">
                  {{ isFormValid ? 'All required fields completed' : 'Required fields missing' }}
                </span>
              </div>
            </div>
            
            <!-- Right side - Action Buttons -->
            <div class="flex items-center space-x-3">
              <!-- Cancel Button -->
              <Button
                variant="outline"
                theme="gray"
                @click="showCreateModal = false"
                class="border-gray-300 hover:border-gray-400"
                :disabled="saving || submitting"
              >
                Cancel
              </Button>
              
              <!-- Save as Draft Button -->
              <Button
                variant="outline"
                theme="blue"
                @click="saveDraft"
                :loading="saving"
                :disabled="submitting"
                class="border-blue-300 hover:border-blue-400 text-blue-700 hover:bg-blue-50"
              >
                <template #prefix v-if="!saving">
                  <DocumentIcon class="h-4 w-4" />
                </template>
                Save Draft
              </Button>
              
              <!-- Submit/Save Button -->
              <Button
                variant="solid"
                :theme="isFormValid ? 'green' : 'blue'"
                @click="isFormValid ? submitPlan() : savePlan()"
                :loading="saving || submitting"
                class="shadow-sm hover:shadow-md transition-all"
              >
                <template #prefix v-if="!saving && !submitting">
                  <CheckCircleIcon class="h-4 w-4" v-if="isFormValid" />
                  <CheckIcon class="h-4 w-4" v-else />
                </template>
                {{ isFormValid ? (editingPlan ? 'Submit Changes' : 'Submit Plan') : (editingPlan ? 'Update Plan' : 'Save Plan') }}
              </Button>
            </div>
          </div>
          
          <!-- Additional Info Bar -->
          <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
            <div class="flex items-center space-x-4">
              <span>Last saved: {{ lastSaved || 'Never' }}</span>
              <span v-if="planForm.plan_id">Plan ID: {{ planForm.plan_id }}</span>
            </div>
            <div class="flex items-center space-x-2">
              <span>Status: {{ planForm.status || 'Draft' }}</span>
              <div class="w-2 h-2 rounded-full" 
                   :class="planForm.status === 'Approved' ? 'bg-green-400' : planForm.status === 'Submitted' ? 'bg-blue-400' : 'bg-gray-400'"></div>
            </div>
          </div>
        </div>
      </template>
    </Dialog>

    <!-- Templates Modal -->
    <Dialog
      v-model="showTemplateModal"
      title="Plan Templates"
      :options="{ size: 'custom', width: '70vw' }"
    >
      <template #body>
        <div class="space-y-6 p-6 bg-gray-50">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-blue-800 text-sm">
               <strong>Pro Tip:</strong> Templates provide a structured starting point. You can customize all sections after selection.
            </p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
            <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg hover:border-blue-300 cursor-pointer transition-all duration-200 group">
              <div class="flex items-start space-x-4 mb-5">
                <div class="flex-shrink-0 p-3 bg-blue-50 rounded-xl group-hover:bg-blue-100 transition-colors">
                  <ClipboardListIcon class="h-6 w-6 text-blue-600" />
                </div>
                <div class="flex-1">
                  <h3 class="font-bold text-gray-900 text-lg mb-2 group-hover:text-blue-900 transition-colors">Standard Financial Audit Plan</h3>
                  <p class="text-gray-600 text-sm leading-relaxed">Comprehensive financial audit coverage with industry best practices</p>
                </div>
              </div>
              
              <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">Includes:</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-blue-400 rounded-full"></div>
                    <span>Revenue cycle audits</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-blue-400 rounded-full"></div>
                    <span>Expenditure cycle audits</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-blue-400 rounded-full"></div>
                    <span>Cash and treasury management</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-blue-400 rounded-full"></div>
                    <span>Financial reporting compliance</span>
                  </li>
                </ul>
              </div>
              
              <Button
                variant="solid"
                theme="blue"
                size="md"
                class="w-full shadow-sm hover:shadow-md transition-shadow"
              >
                <template #prefix>
                  <PlusIcon class="h-4 w-4" />
                </template>
                Use This Template
              </Button>
            </div>

            <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg hover:border-green-300 cursor-pointer transition-all duration-200 group">
              <div class="flex items-start space-x-4 mb-5">
                <div class="flex-shrink-0 p-3 bg-green-50 rounded-xl group-hover:bg-green-100 transition-colors">
                  <CheckCircleIcon class="h-6 w-6 text-green-600" />
                </div>
                <div class="flex-1">
                  <h3 class="font-bold text-gray-900 text-lg mb-2 group-hover:text-green-900 transition-colors">Compliance Audit Plan</h3>
                  <p class="text-gray-600 text-sm leading-relaxed">Regulatory compliance focused with comprehensive coverage</p>
                </div>
              </div>
              
              <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">Includes:</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-green-400 rounded-full"></div>
                    <span>Regulatory compliance checks</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-green-400 rounded-full"></div>
                    <span>Policy adherence audits</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-green-400 rounded-full"></div>
                    <span>Legal requirement validation</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-green-400 rounded-full"></div>
                    <span>Risk management compliance</span>
                  </li>
                </ul>
              </div>
              
              <Button
                variant="solid"
                theme="green"
                size="md"
                class="w-full shadow-sm hover:shadow-md transition-shadow"
              >
                <template #prefix>
                  <CheckCircleIcon class="h-4 w-4" />
                </template>
                Use This Template
              </Button>
            </div>

            <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg hover:border-purple-300 cursor-pointer transition-all duration-200 group">
              <div class="flex items-start space-x-4 mb-5">
                <div class="flex-shrink-0 p-3 bg-purple-50 rounded-xl group-hover:bg-purple-100 transition-colors">
                  <UsersIcon class="h-6 w-6 text-purple-600" />
                </div>
                <div class="flex-1">
                  <h3 class="font-bold text-gray-900 text-lg mb-2 group-hover:text-purple-900 transition-colors">Operational Audit Plan</h3>
                  <p class="text-gray-600 text-sm leading-relaxed">Process efficiency and effectiveness optimization</p>
                </div>
              </div>
              
              <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">Includes:</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-purple-400 rounded-full"></div>
                    <span>Process efficiency reviews</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-purple-400 rounded-full"></div>
                    <span>Resource utilization audits</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-purple-400 rounded-full"></div>
                    <span>Performance metric analysis</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-purple-400 rounded-full"></div>
                    <span>Operational risk assessments</span>
                  </li>
                </ul>
              </div>
              
              <Button
                variant="solid"
                theme="gray"
                size="md"
                class="w-full shadow-sm hover:shadow-md transition-shadow bg-purple-600 hover:bg-purple-700 text-white border-purple-600"
              >
                <template #prefix>
                  <UsersIcon class="h-4 w-4" />
                </template>
                Use This Template
              </Button>
            </div>

            <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg hover:border-amber-300 cursor-pointer transition-all duration-200 group">
              <div class="flex items-start space-x-4 mb-5">
                <div class="flex-shrink-0 p-3 bg-amber-50 rounded-xl group-hover:bg-amber-100 transition-colors">
                  <ClockIcon class="h-6 w-6 text-amber-600" />
                </div>
                <div class="flex-1">
                  <h3 class="font-bold text-gray-900 text-lg mb-2 group-hover:text-amber-900 transition-colors">Risk-Based Audit Plan</h3>
                  <p class="text-gray-600 text-sm leading-relaxed">Risk-prioritized audit approach with dynamic planning</p>
                </div>
              </div>
              
              <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">Includes:</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-amber-400 rounded-full"></div>
                    <span>High-risk area focus</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-amber-400 rounded-full"></div>
                    <span>Risk assessment integration</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-amber-400 rounded-full"></div>
                    <span>Continuous monitoring</span>
                  </li>
                  <li class="flex items-center space-x-2">
                    <div class="h-1.5 w-1.5 bg-amber-400 rounded-full"></div>
                    <span>Dynamic planning approach</span>
                  </li>
                </ul>
              </div>
              
              <Button
                variant="solid"
                theme="gray"
                size="md"
                class="w-full shadow-sm hover:shadow-md transition-shadow bg-amber-500 hover:bg-amber-600 text-white border-amber-500"
              >
                <template #prefix>
                  <ClockIcon class="h-4 w-4" />
                </template>
                Use This Template
              </Button>
            </div>
          </div>
        </div>
      </template>
    </Dialog>

    <!-- Bulk Actions Modal -->
    <Dialog
      v-model="showBulkModal"
      title="Bulk Actions"
      size="xl"
    >
      <template #body>
        <div class="space-y-6">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-blue-800">
              <span class="font-semibold">{{ selectedPlans.length }}</span> plan(s) selected for bulk action.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-1">
              <Button
                variant="solid"
                theme="green"
                class="h-20 w-full"
                @click="bulkUpdateStatus"
              >
                <div class="flex flex-col items-center justify-center space-y-2">
                  <CheckCircleIcon class="h-5 w-5" />
                  <span class="text-sm font-medium">Update Status</span>
                </div>
              </Button>
            </div>

            <div class="p-1">
              <Button
                variant="solid"
                theme="blue"
                class="h-20 w-full"
                @click="bulkExport"
              >
                <div class="flex flex-col items-center justify-center space-y-2">
                  <DownloadIcon class="h-5 w-5" />
                  <span class="text-sm font-medium">Export Selected</span>
                </div>
              </Button>
            </div>

            <div class="p-1">
              <Button
                variant="solid"
                theme="purple"
                class="h-20 w-full"
                @click="bulkDuplicate"
              >
                <div class="flex flex-col items-center justify-center space-y-2">
                  <CopyIcon class="h-5 w-5" />
                  <span class="text-sm font-medium">Duplicate Plans</span>
                </div>
              </Button>
            </div>

            <div class="p-1">
              <Button
                variant="solid"
                theme="red"
                class="h-20 w-full"
                @click="bulkDelete"
              >
                <div class="flex flex-col items-center justify-center space-y-2">
                  <TrashIcon class="h-5 w-5" />
                  <span class="text-sm font-medium">Delete Selected</span>
                </div>
              </Button>
            </div>
          </div>
        </div>
      </template>
    </Dialog>

    <!-- Capacity Planning Modal -->
    <Dialog
      v-model="showCapacityModal"
      title="Capacity Planning Dashboard"
      size="5xl"
    >
      <template #body>
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-blue-50 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-blue-900 mb-4">Resource Summary</h3>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-blue-700">Total Available Days</span>
                  <span class="font-medium text-blue-900">{{ totalPlannedDays }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-blue-700">Allocated Days</span>
                  <span class="font-medium text-blue-900">{{ totalPlannedDays * 0.8 }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-blue-700">Available Days</span>
                  <span class="font-medium text-blue-900">{{ totalPlannedDays * 0.2 }}</span>
                </div>
              </div>
            </div>

            <div class="bg-green-50 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-green-900 mb-4">Utilization Analysis</h3>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-green-700">Average Utilization</span>
                  <span class="font-medium text-green-900">{{ averageUtilization }}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-green-700">Peak Utilization</span>
                  <span class="font-medium text-green-900">95%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-green-700">Optimal Range</span>
                  <span class="font-medium text-green-900">75-85%</span>
                </div>
              </div>
            </div>

            <div class="bg-yellow-50 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-yellow-900 mb-4">Planning Insights</h3>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-yellow-700">Active Plans</span>
                  <span class="font-medium text-yellow-900">{{ activePlansCount }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-yellow-700">Upcoming Audits</span>
                  <span class="font-medium text-yellow-900">{{ upcomingAuditsCount }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-yellow-700">Resource Buffer</span>
                  <span class="font-medium text-yellow-900">15%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white border border-gray-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Capacity Timeline</h3>
            <div class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
              <p class="text-gray-500">Capacity timeline chart would be displayed here</p>
            </div>
          </div>
        </div>
      </template>
    </Dialog>
  </div>
</template>

<script setup>
import { useAuditStore } from "@/stores/audit"
import { useDataStore } from "@/stores/data"
import { Badge, Button, Dialog, FormControl, Select } from "frappe-ui"
import {
	ArrowUpDownIcon,
	BarChart3Icon,
	CalendarIcon,
	CheckCircleIcon,
	CheckIcon,
	ClipboardListIcon,
	ClockIcon,
	CopyIcon,
	FileTextIcon as DocumentIcon,
	DownloadIcon,
	EditIcon,
	EyeIcon,
	FileTextIcon,
	LayersIcon,
	LayoutGridIcon,
	MoreHorizontalIcon,
	PlusIcon,
	RefreshCwIcon,
	SearchIcon,
	TableIcon,
	TrashIcon,
	UsersIcon,
} from "lucide-vue-next"
import { computed, onMounted, ref, watch } from "vue"
import { useRouter } from "vue-router"

const router = useRouter()
const auditStore = useAuditStore()
const dataStore = useDataStore()

// Reactive state
const loading = ref(false)
const saving = ref(false)
const submitting = ref(false)
const lastSaved = ref(null)
const exporting = ref(false)
const showCreateModal = ref(false)
const showTemplateModal = ref(false)
const showBulkModal = ref(false)
const showCapacityModal = ref(false)
const editingPlan = ref(null)

// UI state
const viewMode = ref("table") // 'table' or 'cards'
const searchQuery = ref("")
const statusFilter = ref("")
const yearFilter = ref("")
const selectedPlans = ref([])
const sortField = ref("plan_year")
const sortDirection = ref("desc")
const currentSection = ref(0)

// Form sections for progress tracking
const formSections = ref([
	{
		id: "basic",
		title: "Basic Information",
		description: "Plan ID, year, and status",
	},
	{
		id: "timeline",
		title: "Timeline & Objectives",
		description: "Dates and plan objectives",
	},
	{
		id: "resources",
		title: "Resources & Budget",
		description: "Budget and resource allocation",
	},
	{
		id: "governance",
		title: "Governance & Approval",
		description: "Approval workflow",
	},
	{
		id: "audits",
		title: "Planned Audits",
		description: "Individual audit planning",
	},
])

// Form data
const planForm = ref({
	// Basic Information
	plan_id: "",
	plan_year: new Date().getFullYear(),
	plan_period: "Annual",
	status: "Draft",

	// Plan Details
	plan_title: "",
	plan_description: "",
	plan_objectives: "",
	scope_and_coverage: "",
	key_assumptions: "",
	risk_factors: "",

	// Approval & Governance
	prepared_by: "",
	reviewed_by: "",
	approved_by: "",
	board_approval_required: false,
	audit_committee_review: false,

	// Dates & Timeline
	plan_start_date: "",
	plan_end_date: "",
	approval_deadline: "",
	submission_date: "",

	// Resources & Budget
	total_available_days: 0,
	total_planned_days: 0,
	utilization_percentage: 0,
	total_budget: 0,
	currency: "KES",

	// Team & Skills
	team_size: 0,
	required_skills: [],
	external_resources_required: false,
	external_budget: 0,

	// Risk & Compliance
	regulatory_requirements: "",
	compliance_frameworks: [],
	risk_assessment: "",
	materiality_threshold: 0,

	// Quality & Standards
	audit_standards: [],
	quality_control_measures: "",
	peer_review_required: false,

	// Reporting & Communication
	reporting_frequency: "Quarterly",
	stakeholder_communication_plan: "",
	escalation_procedures: "",

	// Performance Metrics
	success_criteria: "",
	kpis: [],
	target_coverage: 0,

	// Planned Audits
	planned_audits: [],
})

// Options
const periodOptions = [
	{ label: "Annual", value: "Annual" },
	{ label: "Semi-Annual", value: "Semi-Annual" },
	{ label: "Quarterly", value: "Quarterly" },
]

const statusOptions = [
	{ label: "Draft", value: "Draft" },
	{ label: "Under Review", value: "Under Review" },
	{ label: "Submitted for Approval", value: "Submitted for Approval" },
	{ label: "Approved", value: "Approved" },
	{ label: "Rejected", value: "Rejected" },
	{ label: "Active", value: "Active" },
	{ label: "Completed", value: "Completed" },
	{ label: "Suspended", value: "Suspended" },
	{ label: "Cancelled", value: "Cancelled" },
]

const auditTypeOptions = [
	{ label: "Financial", value: "Financial" },
	{ label: "Operational", value: "Operational" },
	{ label: "Compliance", value: "Compliance" },
	{ label: "IT", value: "IT" },
	{ label: "Integrated", value: "Integrated" },
	{ label: "Special Investigation", value: "Special Investigation" },
	{ label: "Follow-up", value: "Follow-up" },
]

const priorityOptions = [
	{ label: "Critical", value: "Critical" },
	{ label: "High", value: "High" },
	{ label: "Medium", value: "Medium" },
	{ label: "Low", value: "Low" },
]

const currencyOptions = [
	{ label: "KES - Kenyan Shilling", value: "KES" },
	{ label: "USD - US Dollar", value: "USD" },
	{ label: "EUR - Euro", value: "EUR" },
	{ label: "GBP - British Pound", value: "GBP" },
]

const skillOptions = [
	{ label: "Financial Auditing", value: "financial_auditing" },
	{ label: "IT Auditing", value: "it_auditing" },
	{ label: "Compliance Review", value: "compliance_review" },
	{ label: "Risk Assessment", value: "risk_assessment" },
	{ label: "Forensic Investigation", value: "forensic_investigation" },
	{ label: "Data Analytics", value: "data_analytics" },
	{ label: "Process Improvement", value: "process_improvement" },
	{ label: "Regulatory Knowledge", value: "regulatory_knowledge" },
]

const complianceFrameworkOptions = [
	{ label: "ISO 27001", value: "iso_27001" },
	{ label: "COSO Framework", value: "coso" },
	{ label: "King IV Report", value: "king_iv" },
	{ label: "Basel III", value: "basel_iii" },
	{ label: "IFRS", value: "ifrs" },
	{ label: "PCI DSS", value: "pci_dss" },
	{ label: "SOX Compliance", value: "sox" },
	{ label: "GDPR", value: "gdpr" },
]

const auditStandardOptions = [
	{ label: "IIA Standards", value: "iia_standards" },
	{ label: "ISACA Standards", value: "isaca_standards" },
	{ label: "ISA Standards", value: "isa_standards" },
	{ label: "PCAOB Standards", value: "pcaob_standards" },
	{ label: "INTOSAI Standards", value: "intosai_standards" },
	{ label: "Local Standards", value: "local_standards" },
]

const reportingFrequencyOptions = [
	{ label: "Weekly", value: "Weekly" },
	{ label: "Monthly", value: "Monthly" },
	{ label: "Quarterly", value: "Quarterly" },
	{ label: "Semi-Annual", value: "Semi-Annual" },
	{ label: "Annual", value: "Annual" },
]

const kpiOptions = [
	{ label: "Audit Universe Coverage", value: "universe_coverage" },
	{ label: "Budget Utilization", value: "budget_utilization" },
	{ label: "Timeline Adherence", value: "timeline_adherence" },
	{ label: "Quality Score", value: "quality_score" },
	{ label: "Stakeholder Satisfaction", value: "stakeholder_satisfaction" },
	{ label: "Finding Implementation Rate", value: "implementation_rate" },
	{ label: "Risk Coverage", value: "risk_coverage" },
	{ label: "Value Addition", value: "value_addition" },
]

// Computed properties
const annualPlans = computed(() => auditStore.annualPlans)
const activePlansCount = computed(() => auditStore.activeAnnualPlans.length)
const plannedAuditsCount = computed(() => auditStore.plannedAudits.length)

// Form validation and calculations
const isFormValid = computed(() => {
	return (
		planForm.value.plan_id &&
		planForm.value.plan_year &&
		planForm.value.plan_title &&
		planForm.value.plan_objectives &&
		planForm.value.scope_and_coverage &&
		planForm.value.plan_start_date &&
		planForm.value.plan_end_date &&
		planForm.value.total_available_days > 0
	)
})

const calculatedUtilization = computed(() => {
	if (
		planForm.value.total_available_days > 0 &&
		planForm.value.total_planned_days > 0
	) {
		return Math.round(
			(planForm.value.total_planned_days /
				planForm.value.total_available_days) *
				100,
		)
	}
	return 0
})

// Update utilization automatically
watch(
	() => [
		planForm.value.total_available_days,
		planForm.value.total_planned_days,
	],
	() => {
		planForm.value.utilization_percentage = calculatedUtilization.value
	},
	{ immediate: true },
)
const upcomingAuditsCount = computed(() => auditStore.upcomingAudits.length)
const totalPlannedDays = computed(() => {
	return annualPlans.value.reduce((total, plan) => {
		return total + (plan.total_planned_days || 0)
	}, 0)
})

const averageUtilization = computed(() => {
	const plans = auditStore.activeAnnualPlans
	if (plans.length === 0) return 0
	const total = plans.reduce(
		(sum, plan) => sum + (plan.utilization_percentage || 0),
		0,
	)
	return Math.round(total / plans.length)
})

const auditUniverseOptions = computed(() => {
	return auditStore.auditUniverse.map((universe) => ({
		label: `${universe.universe_id} - ${universe.auditable_entity}`,
		value: universe.name,
	}))
})

const yearOptions = computed(() => {
	const years = [
		...new Set(annualPlans.value.map((plan) => plan.plan_year)),
	].sort((a, b) => b - a)
	return years.map((year) => ({
		label: year.toString(),
		value: year.toString(),
	}))
})

const filteredPlans = computed(() => {
	let filtered = [...annualPlans.value]

	// Apply search filter
	if (searchQuery.value) {
		const query = searchQuery.value.toLowerCase()
		filtered = filtered.filter(
			(plan) =>
				plan.plan_id?.toLowerCase().includes(query) ||
				plan.status?.toLowerCase().includes(query) ||
				plan.plan_objectives?.toLowerCase().includes(query),
		)
	}

	// Apply status filter
	if (statusFilter.value) {
		filtered = filtered.filter((plan) => plan.status === statusFilter.value)
	}

	// Apply year filter
	if (yearFilter.value) {
		filtered = filtered.filter(
			(plan) => plan.plan_year.toString() === yearFilter.value,
		)
	}

	// Apply sorting
	filtered.sort((a, b) => {
		const aVal = a[sortField.value] || ""
		const bVal = b[sortField.value] || ""

		if (sortDirection.value === "asc") {
			return aVal > bVal ? 1 : -1
		} else {
			return aVal < bVal ? 1 : -1
		}
	})

	return filtered
})

// Methods
const refreshData = async () => {
	loading.value = true
	try {
		await Promise.all([
			auditStore.fetchAnnualPlans(),
			auditStore.fetchAuditUniverse(),
			auditStore.fetchAuditCalendar(),
		])
	} finally {
		loading.value = false
	}
}

const viewPlan = (plan) => {
	// Navigate to plan detail view
	router.push(`/audit-planning/annual-plan/${plan.name}`)
}

const editPlan = (plan) => {
	editingPlan.value = plan
	// Load plan data into form
	planForm.value = { ...plan }
	showCreateModal.value = true
}

const duplicatePlan = async (plan) => {
	try {
		const planDetails = await auditStore.fetchAnnualPlanDetails(plan.name)
		if (planDetails) {
			editingPlan.value = null
			planForm.value = {
				...planDetails,
				plan_id: `${planDetails.plan_id}_copy`,
				status: "Draft",
			}
			showCreateModal.value = true
		}
	} catch (error) {
		console.error("Error duplicating plan:", error)
	}
}

const addPlannedAudit = () => {
	planForm.value.planned_audits.push({
		audit_universe: "",
		audit_type: "",
		priority: "Medium",
		planned_start_date: "",
		planned_end_date: "",
		planned_days: 0,
		lead_auditor: "",
		objectives: "",
		scope: "",
	})
}

const removePlannedAudit = (index) => {
	planForm.value.planned_audits.splice(index, 1)
}

const savePlan = async () => {
	saving.value = true
	try {
		// Set status as draft if not set
		if (!planForm.value.status) {
			planForm.value.status = "Draft"
		}

		if (editingPlan.value) {
			await auditStore.updateAnnualPlan(editingPlan.value.name, planForm.value)
		} else {
			await auditStore.createAnnualPlan(planForm.value)
		}

		lastSaved.value = new Date().toLocaleTimeString()
		showCreateModal.value = false
		resetForm()
		await refreshData()
	} catch (error) {
		console.error("Error saving plan:", error)
	} finally {
		saving.value = false
	}
}

const saveDraft = async () => {
	saving.value = true
	try {
		// Always save as draft
		planForm.value.status = "Draft"

		if (editingPlan.value) {
			await auditStore.updateAnnualPlan(editingPlan.value.name, planForm.value)
		} else {
			await auditStore.createAnnualPlan(planForm.value)
		}

		lastSaved.value = new Date().toLocaleTimeString()
		// Don't close dialog for drafts, allow continued editing
		await refreshData()
	} catch (error) {
		console.error("Error saving draft:", error)
	} finally {
		saving.value = false
	}
}

const submitPlan = async () => {
	submitting.value = true
	try {
		// Set status as submitted
		planForm.value.status = "Submitted"
		planForm.value.submission_date = new Date().toISOString().split("T")[0]

		if (editingPlan.value) {
			await auditStore.updateAnnualPlan(editingPlan.value.name, planForm.value)
		} else {
			await auditStore.createAnnualPlan(planForm.value)
		}

		lastSaved.value = new Date().toLocaleTimeString()
		showCreateModal.value = false
		resetForm()
		await refreshData()
	} catch (error) {
		console.error("Error submitting plan:", error)
	} finally {
		submitting.value = false
	}
}

// Interactive form methods
const scrollToSection = (sectionIndex) => {
	currentSection.value = sectionIndex
	const element = document.querySelector(`[data-section="${sectionIndex}"]`)
	if (element) {
		element.scrollIntoView({ behavior: "smooth", block: "start" })
	}
}

const getSectionStatus = (sectionId) => {
	switch (sectionId) {
		case "basic":
			const basicComplete =
				planForm.value.plan_id &&
				planForm.value.plan_year &&
				planForm.value.plan_title
			const basicPartial = planForm.value.plan_id || planForm.value.plan_year
			return basicComplete ? "complete" : basicPartial ? "partial" : "empty"
		case "timeline":
			const timelineComplete =
				planForm.value.plan_start_date &&
				planForm.value.plan_end_date &&
				planForm.value.plan_objectives
			const timelinePartial =
				planForm.value.plan_start_date || planForm.value.plan_objectives
			return timelineComplete
				? "complete"
				: timelinePartial
					? "partial"
					: "empty"
		case "resources":
			const resourcesComplete = planForm.value.total_available_days > 0
			const resourcesPartial =
				planForm.value.total_budget > 0 || planForm.value.team_size > 0
			return resourcesComplete
				? "complete"
				: resourcesPartial
					? "partial"
					: "empty"
		case "governance":
			const governanceComplete =
				planForm.value.prepared_by && planForm.value.reviewed_by
			const governancePartial =
				planForm.value.prepared_by || planForm.value.reviewed_by
			return governanceComplete
				? "complete"
				: governancePartial
					? "partial"
					: "empty"
		case "audits":
			return planForm.value.planned_audits.length > 0 ? "complete" : "empty"
		default:
			return "empty"
	}
}

const overallProgress = computed(() => {
	const sections = formSections.value
	let totalProgress = 0
	sections.forEach((section) => {
		const status = getSectionStatus(section.id)
		if (status === "complete") totalProgress += 100
		else if (status === "partial") totalProgress += 50
	})
	return Math.round(totalProgress / sections.length)
})

const generatePlanId = () => {
	const year = planForm.value.plan_year || new Date().getFullYear()
	const period = planForm.value.plan_period || "Annual"
	const periodCode = period.charAt(0).toUpperCase()
	const timestamp = Date.now().toString().slice(-4)
	planForm.value.plan_id = `AP-${year}-${periodCode}${timestamp}`
}

const updatePlanDates = () => {
	if (planForm.value.plan_year && !planForm.value.plan_start_date) {
		planForm.value.plan_start_date = `${planForm.value.plan_year}-01-01`
		planForm.value.plan_end_date = `${planForm.value.plan_year}-12-31`
	}
}

const resetForm = () => {
	planForm.value = {
		// Basic Information
		plan_id: "",
		plan_year: new Date().getFullYear(),
		plan_period: "Annual",
		status: "Draft",

		// Plan Details
		plan_title: "",
		plan_description: "",
		plan_objectives: "",
		scope_and_coverage: "",
		key_assumptions: "",
		risk_factors: "",

		// Approval & Governance
		prepared_by: "",
		reviewed_by: "",
		approved_by: "",
		board_approval_required: false,
		audit_committee_review: false,

		// Dates & Timeline
		plan_start_date: "",
		plan_end_date: "",
		approval_deadline: "",
		submission_date: "",

		// Resources & Budget
		total_available_days: 0,
		total_planned_days: 0,
		utilization_percentage: 0,
		total_budget: 0,
		currency: "KES",

		// Team & Skills
		team_size: 0,
		required_skills: [],
		external_resources_required: false,
		external_budget: 0,

		// Risk & Compliance
		regulatory_requirements: "",
		compliance_frameworks: [],
		risk_assessment: "",
		materiality_threshold: 0,

		// Quality & Standards
		audit_standards: [],
		quality_control_measures: "",
		peer_review_required: false,

		// Reporting & Communication
		reporting_frequency: "Quarterly",
		stakeholder_communication_plan: "",
		escalation_procedures: "",

		// Performance Metrics
		success_criteria: "",
		kpis: [],
		target_coverage: 0,

		// Planned Audits
		planned_audits: [],
	}
	editingPlan.value = null
}

const getStatusVariant = (status) => {
	const variants = {
		Draft: "secondary",
		"Submitted for Approval": "warning",
		Approved: "success",
		Rejected: "danger",
		Active: "primary",
		Completed: "success",
	}
	return variants[status] || "secondary"
}

// Enhanced utility methods
const getPlanProgress = (plan) => {
	// Calculate progress based on completed audits vs planned audits
	const plannedAudits = plan.planned_audits || []
	if (plannedAudits.length === 0) return 0

	// For now, use utilization as a proxy for progress
	return Math.min(plan.utilization_percentage || 0, 100)
}

const getUtilizationColor = (utilization) => {
	if (utilization >= 90) return "bg-red-500"
	if (utilization >= 75) return "bg-yellow-500"
	if (utilization >= 50) return "bg-green-500"
	return "bg-blue-500"
}

const formatDate = (dateString) => {
	if (!dateString) return ""
	return new Date(dateString).toLocaleDateString("en-US", {
		year: "numeric",
		month: "short",
		day: "numeric",
	})
}

// Selection methods
const togglePlanSelection = (planName) => {
	const index = selectedPlans.value.indexOf(planName)
	if (index > -1) {
		selectedPlans.value.splice(index, 1)
	} else {
		selectedPlans.value.push(planName)
	}
}

const selectAllPlans = () => {
	if (selectedPlans.value.length === filteredPlans.value.length) {
		selectedPlans.value = []
	} else {
		selectedPlans.value = filteredPlans.value.map((plan) => plan.name)
	}
}

// Sorting methods
const sortBy = (field) => {
	if (sortField.value === field) {
		sortDirection.value = sortDirection.value === "asc" ? "desc" : "asc"
	} else {
		sortField.value = field
		sortDirection.value = "asc"
	}
}

// Filter methods
const clearFilters = () => {
	searchQuery.value = ""
	statusFilter.value = ""
	yearFilter.value = ""
	selectedPlans.value = []
}

// Enhanced action methods
const exportPlans = async () => {
	exporting.value = true
	try {
		// TODO: Implement export functionality
		console.log(
			"Exporting plans...",
			selectedPlans.value.length || filteredPlans.value.length,
			"plans",
		)
	} catch (error) {
		console.error("Error exporting plans:", error)
	} finally {
		exporting.value = false
	}
}

const showPlanMenu = (plan, event) => {
	// TODO: Implement context menu
	console.log(
		"Show context menu for plan:",
		plan.name,
		"at",
		event.clientX,
		event.clientY,
	)
}

// Bulk action methods
const bulkUpdateStatus = () => {
	console.log("Bulk update status for:", selectedPlans.value)
	showBulkModal.value = false
}

const bulkExport = () => {
	console.log("Bulk export for:", selectedPlans.value)
	showBulkModal.value = false
}

const bulkDuplicate = () => {
	console.log("Bulk duplicate for:", selectedPlans.value)
	showBulkModal.value = false
}

const bulkDelete = () => {
	console.log("Bulk delete for:", selectedPlans.value)
	showBulkModal.value = false
}

// Lifecycle
onMounted(async () => {
	await refreshData()
})
</script>